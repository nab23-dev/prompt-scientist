<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt Scientist — Profile</title>

  <style>
    :root {
      --accent: #204ecf;
      --accent-dark: #163ea0;
      --muted: #6b7280;
      --bg: #f3f6fb;
      --white: #ffffff;
      --shadow: 0 8px 24px rgba(15,23,42,0.08);
      --radius: 14px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: "Inter", system-ui, sans-serif;
      background: var(--bg);
      color: #0f172a;
      line-height: 1.5;
    }

    header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: var(--white);
      box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      padding: 16px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    header h1 {
      font-size: 20px;
      color: var(--accent);
      font-weight: 700;
    }

    main {
      max-width: 900px;
      margin: 30px auto;
      padding: 0 16px 80px;
      display: flex;
      flex-direction: column;
      gap: 24px;
    }

    /* ---------- Profile ---------- */
    .profile-card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 10px;
    }

    .avatar {
      width: 88px;
      height: 88px;
      border-radius: 50%;
      background: var(--accent);
      color: #fff;
      font-size: 32px;
      font-weight: 700;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(32,78,207,0.3);
    }

    .profile-meta h2 { margin: 8px 0 2px; font-size: 20px; }
    .profile-meta p { margin: 0; color: var(--muted); font-size: 14px; }

    .profile-actions {
      margin-top: 12px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
    }

    .btn {
      padding: 10px 16px;
      border-radius: 8px;
      font-weight: 600;
      border: none;
      cursor: pointer;
      transition: background .2s;
    }

    .btn-manage {
      background: var(--accent);
      color: #fff;
    }

    .btn-manage:hover { background: var(--accent-dark); }
    .btn-logout {
      background: #f8f9fb;
      color: var(--accent);
      border: 1px solid rgba(32,78,207,0.1);
    }
    .btn-logout:hover { background: #eef2ff; }

    /* ---------- Post Form ---------- */
    .card {
      background: var(--white);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 20px;
    }

    .card h3 { font-size: 18px; margin-bottom: 8px; }

    .field {
      display: flex;
      flex-direction: column;
      margin-top: 14px;
    }

    label {
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    input, textarea {
      padding: 10px 12px;
      border: 1px solid rgba(15,23,42,0.08);
      border-radius: 8px;
      font-size: 14px;
      outline: none;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    input:focus, textarea:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(32,78,207,0.12);
    }

    textarea { resize: vertical; min-height: 100px; }

    .btn-submit {
      background: var(--accent);
      color: #fff;
      border: none;
      padding: 12px 18px;
      border-radius: 10px;
      font-weight: 700;
      cursor: pointer;
      margin-top: 16px;
      transition: background .2s;
    }
    .btn-submit:hover { background: var(--accent-dark); }

    /* ---------- Posts ---------- */
    .posts-list {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .post-card {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .post-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .post-caption {
      font-size: 16px;
      font-weight: 600;
      color: #111;
    }

    .post-time {
      font-size: 13px;
      color: var(--muted);
    }

    .post-status {
      font-size: 13px;
      font-weight: 600;
      color: var(--accent);
    }

    .post-image {
      width: 100%;
      height: auto;
      max-height: 400px;
      object-fit: contain;
      border-radius: 10px;
      background: #f8fafc;
    }

    .post-prompt {
      font-family: "Roboto Mono", monospace;
      background: #f9fafb;
      padding: 12px;
      border-radius: 8px;
      border: 1px solid rgba(15,23,42,0.05);
      font-size: 13.5px;
      color: #0f172a;
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: break-word;
      line-height: 1.5;
    }

    .see-more {
      background: none;
      border: none;
      color: var(--accent);
      font-weight: 600;
      font-size: 13px;
      cursor: pointer;
      align-self: flex-start;
    }

    .post-actions {
      display: flex;
      justify-content: flex-end;
    }

    .btn-delete {
      background: #f44336;
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      cursor: pointer;
      transition: background .2s;
    }

    .btn-delete:hover { background: #c62828; }

    .loader {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 4px solid #e6eefc;
      border-top: 4px solid var(--accent);
      animation: spin 1s linear infinite;
      margin: 18px auto;
    }

    @keyframes spin { to { transform: rotate(360deg); } }

    .empty {
      padding: 28px;
      text-align: center;
      color: var(--muted);
    }

    @media (max-width:600px){
      main { padding: 0 12px 60px; }
      .post-image { max-height: 250px; }
    }
  </style>
</head>
<body>

  <header>
    <h1>Prompt Scientist</h1>
    <span style="color:#64748b;font-weight:600;">My Profile</span>
  </header>

  <main>
    <!-- Profile -->
    <section class="profile-card">
      <div class="avatar" id="avatar">P</div>
      <div class="profile-meta">
        <h2 id="userName">Loading...</h2>
        <p id="userHandle">@username</p>
        <p id="userEmail">email@example.com</p>
        <p style="font-size:13px;color:var(--muted)">Member since: <span id="userSince">—</span></p>
      </div>
      <div class="profile-actions">
        <button id="manageAccountBtn" class="btn btn-manage">Manage account</button>
        <button id="logoutBtn" class="btn btn-logout">Logout</button>
      </div>
    </section>

    <!-- Create Post -->
    <section class="card">
      <h3>Create a new post</h3>
      <div style="font-size:13px;color:var(--muted);margin-bottom:12px">
        Use <a href="https://postimages.org/" target="_blank">postimages.org</a> to upload an image and paste the <strong>Direct link</strong>.
      </div>

      <form id="postForm">
        <div class="field">
          <label for="imageURL">Image URL (Direct link)</label>
          <input id="imageURL" type="url" placeholder="https://i.postimg.cc/..." />
        </div>

        <div class="field">
          <label for="caption">Caption (optional)</label>
          <input id="caption" type="text" placeholder="Short caption" />
        </div>

        <div class="field">
          <label for="prompt">Prompt (required)</label>
          <textarea id="prompt" required placeholder="Write your AI prompt..."></textarea>
        </div>

        <button type="submit" id="submitBtn" class="btn-submit">Submit Post</button>
      </form>
    </section>

    <!-- My Posts -->
    <section class="card">
      <h3>My Posts</h3>
      <div id="postsContainer" class="posts-list">
        <div class="loader"></div>
      </div>
    </section>
  </main>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

// 🔹 Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
  authDomain: "prompt-scientist.firebaseapp.com",
  projectId: "prompt-scientist",
  storageBucket: "prompt-scientist.firebasestorage.app",
  messagingSenderId: "240705146800",
  appId: "1:240705146800:web:e7f05107761f4d3007d075"
};

// 🔹 Initialize Firebase
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// 🔹 Elements
const userNameEl = document.getElementById('userName');
const userHandleEl = document.getElementById('userHandle');
const userEmailEl = document.getElementById('userEmail');
const userSinceEl = document.getElementById('userSince');
const avatarEl = document.getElementById('avatar');
const postsContainer = document.getElementById('postsContainer');
const postForm = document.getElementById('postForm');
const submitBtn = document.getElementById('submitBtn');
const manageAccountBtn = document.getElementById('manageAccountBtn');
const logoutBtn = document.getElementById('logoutBtn');

let currentUser = null, userData = null, allPosts = [], visibleCount = 3;

// 🔹 Auth check
onAuthStateChanged(auth, async (u) => {
  if (!u) { location.href = 'index.html'; return; }
  currentUser = u;
  const userSnap = await getDoc(doc(db, 'users', u.uid));
  userData = userSnap.exists() ? userSnap.data() : { name: 'User', username: '', email: u.email };
  userNameEl.textContent = userData.name || 'User';
  userHandleEl.textContent = userData.username ? `@${userData.username}` : '';
  userEmailEl.textContent = userData.email || u.email;
  avatarEl.textContent = (userData.name ? userData.name.charAt(0) : 'U').toUpperCase();
  userSinceEl.textContent = userData.createdAt ? new Date(userData.createdAt).toLocaleDateString() : '—';
  loadPosts();
});

// 🔹 Load posts
async function loadPosts() {
  postsContainer.innerHTML = '<div class="loader"></div>';
  const q = query(collection(db, 'posts'), where('uid', '==', auth.currentUser.uid));
  const snap = await getDocs(q);
  if (snap.empty) { postsContainer.innerHTML = '<div class="empty">No posts yet.</div>'; return; }
  allPosts = [];
  snap.forEach(docSnap => allPosts.push({ ...docSnap.data(), id: docSnap.id }));
  allPosts.sort((a, b) => (b.timestamp?.seconds || 0) - (a.timestamp?.seconds || 0));
  renderPosts();
}

// 🔹 Render posts
function renderPosts() {
  postsContainer.innerHTML = '';
  const slice = allPosts.slice(0, visibleCount);
  slice.forEach(d => {
    const div = document.createElement('div');
    div.className = 'post-card';
    const shortPrompt = d.prompt.length > 100 ? d.prompt.slice(0, 100) + '...' : d.prompt;
    const isLong = d.prompt.length > 100;
    const status = d.approved ? 'Approved ✅' : 'Pending ⏳';

    div.innerHTML = `
      <div class="post-top">
        <p class="post-caption">${d.caption || '(No caption)'}</p>
        <div class="post-time">${d.timestamp?.toDate ? d.timestamp.toDate().toLocaleString() : 'Unknown'}</div>
      </div>
      ${d.imageURL ? `<img class="post-image" src="${d.imageURL}" alt="post">` : ""}
      <div class="post-prompt">${isLong ? shortPrompt : d.prompt}</div>
      ${isLong ? '<button class="see-more">See more</button>' : ''}
      <div class="post-status">${status}</div>
      <div class="post-actions"><button class="btn-delete" data-id="${d.id}">Delete</button></div>
    `;
    div.querySelector('.btn-delete').addEventListener('click', () => deletePost(d.id));
    if (isLong) {
      const btn = div.querySelector('.see-more');
      const pbox = div.querySelector('.post-prompt');
      let ex = false;
      btn.addEventListener('click', () => {
        ex = !ex;
        pbox.textContent = ex ? d.prompt : shortPrompt;
        btn.textContent = ex ? 'See less' : 'See more';
      });
    }
    postsContainer.appendChild(div);
  });
  if (visibleCount < allPosts.length) {
    const loadBtn = document.createElement('button');
    loadBtn.textContent = 'Load More';
    loadBtn.className = 'btn btn-manage';
    loadBtn.style.margin = '10px auto';
    loadBtn.addEventListener('click', () => { visibleCount += 5; renderPosts(); });
    postsContainer.appendChild(loadBtn);
  }
}

// 🔹 New Post
postForm.addEventListener('submit', async e => {
  e.preventDefault();
  const imageURL = document.getElementById('imageURL').value.trim();
  const caption = document.getElementById('caption').value.trim();
  const prompt = document.getElementById('prompt').value.trim();
  if (!prompt) return alert('Prompt is required');
  submitBtn.disabled = true; submitBtn.textContent = 'Submitting...';
  try {
    // Auto approve check
    const settingsRef = doc(db, 'settings', 'global');
    const settingsSnap = await getDoc(settingsRef);
    const autoApprove = settingsSnap.exists() ? settingsSnap.data().autoApprove === true : false;

    await addDoc(collection(db, 'posts'), {
      uid: auth.currentUser.uid,
      name: userData.name || '',
      username: userData.username || '',
      email: userData.email || auth.currentUser.email,
      imageURL, caption, prompt,
      timestamp: serverTimestamp(),
      approved: autoApprove
    });
    postForm.reset();
    loadPosts();
    alert('Post submitted successfully.');
  } catch (e) { alert('Failed to submit'); }
  submitBtn.disabled = false; submitBtn.textContent = 'Submit Post';
});

// 🔹 Delete Post
async function deletePost(id) {
  if (confirm('Delete this post?')) {
    try {
      await deleteDoc(doc(db, 'posts', id));
      loadPosts();
      alert('Post deleted successfully.');
    } catch (err) {
      console.error('Error deleting post:', err);
      alert('Failed to delete post.');
    }
  }
}

// 🔹 Manage Account & Logout
manageAccountBtn.onclick = () => location.href = 'account-manage.html';
logoutBtn.onclick = () => {
  signOut(auth).then(() => {
    location.href = 'index.html';
  });
};
</script>
</body>
</html>
