<!doctype html>
<html lang="bn">    
<head>    
  <meta charset="utf-8"/>    
  <meta name="viewport" content="width=device-width,initial-scale=1"/>    
  <title>Prompt-Scientist ‚Äî Profile</title>    
  <style>    
    :root{    
      --bg:#f3f4f6;    
      --card:#fff;    
      --accent:#2563eb;    
      --accent-hover:#1e40af;    
      --border:#e5e7eb;    
      --muted:#6b7280;    
      --shadow:0 6px 18px rgba(0,0,0,0.06);    
      --radius:14px;    
      --maxw:880px;    
    }    
    *{box-sizing:border-box;margin:0;padding:0}    
    body{font-family:Inter,system-ui,Roboto,"Noto Sans",sans-serif;background:var(--bg);color:#111827;}    
    header{    
      position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid var(--border);    
      padding:16px 20px;display:flex;justify-content:space-between;align-items:center;    
      box-shadow:0 2px 10px rgba(0,0,0,0.04);    
    }    
    header h1{font-size:22px;font-weight:700;color:var(--accent)}    
    .header-actions{display:flex;gap:10px;}    
    header button{    
      padding:8px 14px;border:none;border-radius:8px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer;    
      transition:background .2s;    
    }    
    header button:hover{background:var(--accent-hover);}    

    .container{max-width:var(--maxw);margin:20px auto;padding:0 18px;display:grid;gap:22px;}    
    .card{background:var(--card);border-radius:var(--radius);padding:20px;box-shadow:var(--shadow);}    

    .profile-info h2{margin-bottom:6px;font-size:20px}    
    .profile-info p{color:var(--muted);font-size:14px}    

    form label{display:block;margin-top:12px;font-weight:600;font-size:14px;}    
    form input, form textarea{
      width:100%;margin-top:6px;padding:10px;border-radius:10px;border:1px solid var(--border);font-size:14px;
    }
    form textarea{min-height:80px;resize:vertical;}
    form button{
      margin-top:16px;padding:12px 18px;border:none;border-radius:10px;background:var(--accent);color:#fff;
      font-weight:600;cursor:pointer;transition:background .2s;
    }
    form button:hover{background:var(--accent-hover);}
    .msg{margin-top:10px;font-size:14px;color:var(--muted)}

    .posts{display:grid;gap:18px;}
    .post{padding:16px;display:flex;flex-direction:column;gap:10px;border:1px solid var(--border);border-radius:12px;background:#fff;box-shadow:var(--shadow);}
    .post h3{font-size:16px;font-weight:600;}
    .post img{max-width:100%;border-radius:10px;object-fit:cover}
    .prompt{background:#f9fafb;border:1px solid var(--border);padding:10px;border-radius:8px;
      font-family:ui-monospace,monospace;font-size:13px;position:relative;}
    .copy-btn{position:absolute;top:6px;right:6px;background:var(--accent);color:#fff;border:none;padding:4px 8px;border-radius:6px;font-size:12px;cursor:pointer;}
    .copy-btn:hover{background:var(--accent-hover);}
    .actions{display:flex;gap:10px;justify-content:flex-end;}
    .actions button{
      padding:6px 12px;font-size:13px;border:none;border-radius:8px;cursor:pointer;
    }
    .delete{background:#ef4444;color:#fff;}
    .delete:hover{background:#b91c1c;}
    .share{background:#f3f4f6;}
    .share:hover{background:#e5e7eb;}
    .empty{padding:28px;text-align:center;color:var(--muted)}

    /* üîπ Saved Posts Popup */
    .modal{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.6);display:none;align-items:center;justify-content:center;z-index:100;}
    .modal.active{display:flex;}
    .modal-content{background:#fff;border-radius:14px;padding:20px;max-width:700px;width:90%;max-height:90vh;overflow-y:auto;box-shadow:var(--shadow);}
    .modal-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:15px;}
    .modal-header h2{font-size:18px;font-weight:700;color:var(--accent);}
    .close{cursor:pointer;font-size:20px;font-weight:700;color:#555;}
    .close:hover{color:#000;}
  </style>    
</head>    
<body>    
  <header>    
    <h1>Prompt-Scientist</h1>    
    <div class="header-actions">
      <button id="savedBtn">üíæ Saved Posts</button>    
      <button id="logoutBtn">Logout</button>    
    </div>
  </header>    

  <main class="container">    
    <!-- Profile -->    
    <section class="card profile-info">    
      <h2 id="userName">Loading...</h2>    
      <p><strong>Username:</strong> <span id="userUsername"></span></p>    
      <p><strong>Email:</strong> <span id="userEmail"></span></p>    
    </section>  

    <!-- New Post Form -->    
    <section class="card">    
      <h2>üìù ‡¶®‡¶§‡ßÅ‡¶® ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßÅ‡¶®</h2>    
      <p class="msg">üì∑ ‡¶õ‡¶¨‡¶ø ‡¶Ü‡¶™‡¶≤‡ßã‡¶° ‡¶ï‡¶∞‡¶§‡ßá <a href="https://postimages.org/" target="_blank">postimages.org</a> ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡ßÅ‡¶® ‡¶è‡¶¨‡¶Ç (üëâDirect link) ‡¶¶‡¶ø‡¶®‡•§</p>    
      <form id="postForm">    
        <label>Image URL    
          <input id="imageURL" type="url" placeholder="https://i.postimg.cc/..."/>    
        </label>    
        <label>Caption (optional)    
          <textarea id="caption" placeholder="‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶ï‡ßç‡¶Ø‡¶æ‡¶™‡¶∂‡¶® ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>    
        </label>    
        <label>Prompt (required)    
          <textarea id="prompt" required placeholder="AI image prompt ‡¶≤‡¶ø‡¶ñ‡ßÅ‡¶®..."></textarea>    
        </label>    
        <button type="submit">üöÄ Submit Post</button>    
      </form>    
    </section>    

    <!-- My Posts -->    
    <section class="card">    
      <h2>üìå ‡¶Ü‡¶Æ‡¶æ‡¶∞ ‡¶™‡ßã‡¶∏‡ßç‡¶ü‡¶ó‡ßÅ‡¶≤‡ßã</h2>    
      <div id="myPosts" class="posts"></div>    
    </section>    
  </main>    

  <!-- üîπ Saved Posts Popup -->
  <div id="savedModal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>üíæ Saved Posts</h2>
        <span class="close" id="closeSaved">&times;</span>
      </div>
      <div id="savedPosts" class="posts"></div>
    </div>
  </div>

  <script type="module">    
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";    
    import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";    
    import { getFirestore, collection, addDoc, getDocs, query, where, orderBy, serverTimestamp, doc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";    

    const firebaseConfig = {    
      apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",    
      authDomain: "prompt-scientist.firebaseapp.com",    
      projectId: "prompt-scientist",    
      storageBucket: "prompt-scientist.firebasestorage.app",    
      messagingSenderId: "240705146800",    
      appId: "1:240705146800:web:e7f05107761f4d3007d075"    
    };    

    const app = initializeApp(firebaseConfig);    
    const auth = getAuth(app);    
    const db = getFirestore(app);    

    const userName=document.getElementById("userName");    
    const userUsername=document.getElementById("userUsername");    
    const userEmail=document.getElementById("userEmail");    
    const postForm=document.getElementById("postForm");    
    const myPosts=document.getElementById("myPosts");    
    const logoutBtn=document.getElementById("logoutBtn");    
    const savedBtn=document.getElementById("savedBtn");    
    const savedModal=document.getElementById("savedModal");    
    const closeSaved=document.getElementById("closeSaved");    
    const savedPosts=document.getElementById("savedPosts");    

    let currentUser=null;    
    let userData=null;    

    // Auth state check    
    onAuthStateChanged(auth,async(u)=>{    
      if(!u){location.href="index.html";return;}    
      currentUser=u;    

      const userRef = doc(db, "users", u.uid);    
      const userSnap = await getDoc(userRef);    
      if(userSnap.exists()){    
        userData = userSnap.data();    
        userName.textContent = userData.name || "User";    
        userUsername.textContent = userData.username ? "@" + userData.username : "";    
        userEmail.textContent = userData.email || u.email;    
      } else {    
        userData = { name:"User", username:"", email:u.email };    
        userName.textContent = "User";    
        userEmail.textContent = u.email;    
      }    

      loadPosts();    
    });    

    logoutBtn.addEventListener("click",()=>signOut(auth));    

    // Load posts    
    async function loadPosts(){    
      myPosts.innerHTML="‚è≥ Loading...";    
      const q=query(collection(db,"posts"),where("uid","==",currentUser.uid),orderBy("timestamp","desc"));    
      const snap=await getDocs(q);    
      if(snap.empty){myPosts.innerHTML='<div class="empty">‚ùå ‡¶Ü‡¶™‡¶®‡¶ø ‡¶è‡¶ñ‡¶®‡¶ì ‡¶ï‡ßã‡¶®‡ßã ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶ï‡¶∞‡ßá‡¶®‡¶®‡¶ø‡•§</div>';return;}    
      myPosts.innerHTML="";    
      snap.forEach(docSnap=>renderPost(docSnap,myPosts,true));    
    }    

    // Render post (for both myPosts & savedPosts)
    function renderPost(docSnap, container, allowDelete=false){    
      const d=docSnap.data();    
      const div=document.createElement("div");    
      div.className="post";    
      div.innerHTML=`    
        <h3>${d.caption||"(No caption)"}</h3>    
        ${d.imageURL?`<img src="${d.imageURL}" alt="post">`:""}    
        <div class="prompt">${d.prompt}<button class="copy-btn">Copy</button></div>    
        <div class="actions">    
          <button class="share">üîó Share</button>    
          ${allowDelete?`<button class="delete" data-id="${docSnap.id}">üóëÔ∏è Delete</button>`:""}    
        </div>    
        <p class="msg">${d.approved?"‚úÖ Approved":"‚è≥ Pending approval"}</p>    
      `;    

      // Copy Prompt
      div.querySelector(".copy-btn").addEventListener("click",()=>{    
        navigator.clipboard.writeText(d.prompt);    
        alert("üìã Prompt copied!");    
      });    

      // Share link
      div.querySelector(".share").addEventListener("click",()=>{    
        const link=`${location.origin}/prompt-scientist/feed.html?id=${docSnap.id}`;    
        navigator.clipboard.writeText(link);    
        alert("üîó Share link copied!");    
      });    

      // Delete (only for my posts)
      if(allowDelete){    
        div.querySelector(".delete").addEventListener("click",()=>deletePost(docSnap.id));    
      }    

      container.appendChild(div);    
    }    

    // New post    
    postForm.addEventListener("submit",async e=>{    
      e.preventDefault();    
      const imageURL=document.getElementById("imageURL").value.trim();    
      const caption=document.getElementById("caption").value.trim();    
      const prompt=document.getElementById("prompt").value.trim();    
      if(!prompt){alert("‚ö†Ô∏è Prompt is required");return;}    

      const settingsRef = doc(db, "settings", "global");    
      const settingsSnap = await getDoc(settingsRef);    
      let autoApprove = false;    
      if (settingsSnap.exists()) {    
        autoApprove = settingsSnap.data().autoApprove === true;    
      }    

      await addDoc(collection(db,"posts"),{    
        uid: currentUser.uid,    
        name: userData?.name || "",    
        username: userData?.username || "",    
        email: userData?.email || currentUser.email,    
        imageURL, caption, prompt,    
        timestamp: serverTimestamp(),    
        approved: autoApprove    
      });    

      alert("‚úÖ Post submitted! Pending admin approval.");    
      postForm.reset();    
      loadPosts();    
    });    

    // Delete post    
    async function deletePost(id){    
      if(confirm("‚ö†Ô∏è ‡¶Ü‡¶™‡¶®‡¶ø ‡¶ï‡¶ø ‡¶°‡¶ø‡¶≤‡¶ø‡¶ü ‡¶ï‡¶∞‡¶§‡ßá ‡¶ö‡¶æ‡¶®?")){    
        await deleteDoc(doc(db,"posts",id));    
        loadPosts();    
      }    
    }    

    // üîπ Saved Posts Modal control
    savedBtn.addEventListener("click",async()=>{    
      savedModal.classList.add("active");    
      savedPosts.innerHTML="‚è≥ Loading...";    
      const q=query(collection(db,"saved"),where("uid","==",currentUser.uid),orderBy("timestamp","desc"));    
      const snap=await getDocs(q);    
      if(snap.empty){savedPosts.innerHTML='<div class="empty">‚ùå ‡¶ï‡ßã‡¶®‡ßã saved ‡¶™‡ßã‡¶∏‡ßç‡¶ü ‡¶®‡ßá‡¶á‡•§</div>';return;}    
      savedPosts.innerHTML="";    
      snap.forEach(docSnap=>renderPost(docSnap,savedPosts,false));    
    });    

    closeSaved.addEventListener("click",()=>savedModal.classList.remove("active"));    
    window.addEventListener("click",(e)=>{if(e.target===savedModal) savedModal.classList.remove("active");});    

  </script>    
</body>    
  </html>
