<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Prompt-Scientist Feed</title>

<!-- Google Fonts -->
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&family=Poppins:wght@400;500;600&display=swap" rel="stylesheet">

<style>
body{ font-family:'Poppins',sans-serif; margin:0; background:#f0f2f5; }
.header{ display:flex; align-items:center; padding:15px 20px; background:#fff; box-shadow:0 1px 5px rgba(0,0,0,0.1); position:sticky; top:0; z-index:100; }
.header .logo{ font-family:'Montserrat',sans-serif; font-weight:700; font-size:24px; color:#333; flex:1; }
.header .profile-icon{ width:40px; height:40px; border-radius:50%; background:#ccc; cursor:pointer; }

.container{ max-width:600px; margin:15px auto; padding:0 10px; }

/* Post card */
.post-card{
  background:#fff;
  border-radius:12px;
  margin-bottom:20px;
  padding:15px;
  box-shadow:0 5px 15px rgba(0,0,0,0.05);
  animation:fadeIn 0.4s ease;
}
.post-card .user-section{
  display:flex;
  align-items:center;
  margin-bottom:8px;
}
.post-card .user-section img{ width:40px; height:40px; border-radius:50%; margin-right:10px; }
.post-card .username{ font-weight:600; color:#333; }
.post-card .timestamp{ font-size:12px; color:#888; margin-left:5px; }

/* Caption */
.caption{ margin-bottom:10px; font-size:14px; color:#333; }

/* Post image */
.post-card img.post-image{ width:100%; border-radius:12px; margin-bottom:10px; max-height:400px; object-fit:cover; }

/* Prompt */
.prompt-section{ background:#eef0f5; padding:10px 12px; border-radius:12px; display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; font-family:monospace; font-size:14px; color:#222; }
.prompt-section button{ border:none; background:#6c63ff; color:#fff; padding:6px 10px; border-radius:8px; cursor:pointer; font-weight:500; transition:0.3s; }
.prompt-section button:hover{ background:#5147d1; }

/* Actions */
.actions{ display:flex; align-items:center; border-top:1px solid #ddd; padding-top:8px; }
.actions button{ display:flex; align-items:center; margin-right:15px; border:none; background:none; cursor:pointer; font-weight:500; font-size:14px; color:#555; }
.actions button i{ margin-right:5px; transition:0.3s; }
.actions button.liked i{ color:#e0245e; }

/* Animation */
@keyframes fadeIn{ from{opacity:0; transform:translateY(10px);} to{opacity:1; transform:translateY(0);} }

@media(max-width:600px){ .container{padding:0 8px;} }
</style>

<!-- FontAwesome for icons -->
<script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
</head>
<body>

<div class="header">
  <div class="logo">Prompt-Scientist</div>
  <div class="profile-icon" onclick="goToProfile()"></div>
</div>

<div class="container" id="feedContainer">
  <!-- Posts will be dynamically loaded here -->
</div>

<script type="module">
// Firebase Import
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getFirestore, collection, query, where, orderBy, getDocs, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
  authDomain: "prompt-scientist.firebaseapp.com",
  projectId: "prompt-scientist",
  storageBucket: "prompt-scientist.firebasestorage.app",
  messagingSenderId: "240705146800",
  appId: "1:240705146800:web:e7f05107761f4d3007d075"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);

let currentUser = null;

onAuthStateChanged(auth,user=>{
  if(!user && !localStorage.getItem("uid")){
    alert("You must login first.");
    window.location.href="index.html";
  } else{
    currentUser = user;
    loadPosts();
  }
});

// Go to profile page
function goToProfile(){
  window.location.href="profile.html";
}

// Load posts
async function loadPosts(){
  const postsRef = collection(db,"posts");
  const q = query(postsRef, where("approved","==",true), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  const feedContainer = document.getElementById("feedContainer");

  snapshot.forEach(docSnap=>{
    const data = docSnap.data();
    const postId = docSnap.id;

    const card = document.createElement("div");
    card.classList.add("post-card");

    const userSection = document.createElement("div");
    userSection.classList.add("user-section");
    userSection.innerHTML = `<img src="${data.userIcon || 'https://via.placeholder.com/40'}" alt="User Icon">
                             <span class="username">${data.username}</span>
                             <span class="timestamp">${data.timestamp?.toDate ? data.timestamp.toDate().toLocaleString() : ''}</span>`;
    card.appendChild(userSection);

    if(data.caption) {
      const cap = document.createElement("div");
      cap.classList.add("caption");
      cap.textContent = data.caption;
      card.appendChild(cap);
    }

    if(data.imageURL){
      const img = document.createElement("img");
      img.classList.add("post-image");
      img.src = data.imageURL;
      card.appendChild(img);
    }

    // Prompt section
    const promptSection = document.createElement("div");
    promptSection.classList.add("prompt-section");
    const promptText = document.createElement("span");
    promptText.textContent = data.prompt;
    const copyBtn = document.createElement("button");
    copyBtn.textContent = "Copy";
    copyBtn.addEventListener("click",()=>{
      navigator.clipboard.writeText(data.prompt);
      copyBtn.textContent = "Copied!";
      setTimeout(()=>{ copyBtn.textContent="Copy"; },1500);
    });
    promptSection.appendChild(promptText);
    promptSection.appendChild(copyBtn);
    card.appendChild(promptSection);

    // Actions
    const actions = document.createElement("div");
    actions.classList.add("actions");
    // Like button
    const likeBtn = document.createElement("button");
    likeBtn.innerHTML = `<i class="fas fa-heart"></i> <span>${data.likes?.length||0}</span>`;
    if(data.likes?.includes(currentUser.uid)) likeBtn.classList.add("liked");
    likeBtn.addEventListener("click", async ()=>{
      const postRef = doc(db,"posts",postId);
      if(data.likes?.includes(currentUser.uid)){
        await updateDoc(postRef,{likes: arrayRemove(currentUser.uid)});
        likeBtn.classList.remove("liked");
        likeBtn.querySelector("span").textContent = (data.likes.length-1);
        data.likes = data.likes.filter(uid=>uid!==currentUser.uid);
      } else{
        await updateDoc(postRef,{likes: arrayUnion(currentUser.uid)});
        likeBtn.classList.add("liked");
        likeBtn.querySelector("span").textContent = (data.likes?.length+1 || 1);
        if(!data.likes) data.likes = [];
        data.likes.push(currentUser.uid);
      }
    });
    actions.appendChild(likeBtn);

    // Comment button
    const commentBtn = document.createElement("button");
    commentBtn.innerHTML = `<i class="fas fa-comment"></i> Comment`;
    commentBtn.addEventListener("click",()=>{
      const userComment = prompt("Enter your comment:");
      if(userComment){
        const postRef = doc(db,"posts",postId);
        updateDoc(postRef,{comments: arrayUnion({uid:currentUser.uid, text:userComment})});
        alert("Comment added!");
      }
    });
    actions.appendChild(commentBtn);

    card.appendChild(actions);

    feedContainer.appendChild(card);
  });
}
</script>

</body>
</html>