<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt-Scientist — Feed</title>

  <!-- Font (system + subtle monospace for prompts) -->
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700;800&family=Share+Tech+Mono&display=swap" rel="stylesheet">

  <style>
    :root{
      --maxw: 920px;
      --radius: 12px;
      --muted: #6b7280;
      --accent-1: #2163ff;   /* blue */
      --accent-2: #7c3aed;   /* purple */
      --bg: #f6f8fb;
      --card: #ffffff;
      --glass: rgba(255,255,255,0.6);
      --elev: 0 8px 22px rgba(18,24,40,0.06);
    }
    /* dark theme vars (applied with body.dark) */
    body.dark {
      --bg: #0b0f14;
      --card: rgba(14,18,24,0.7);
      --glass: rgba(20,25,32,0.5);
      --elev: 0 12px 30px rgba(2,6,23,0.6);
      --muted: #9aa6bb;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
      background:
        radial-gradient(1200px 400px at 10% 10%, rgba(124,58,237,0.06), transparent 12%),
        radial-gradient(1000px 300px at 90% 90%, rgba(33,99,255,0.04), transparent 12%),
        var(--bg);
      color: #0b1220;
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
      transition: background .25s ease, color .2s ease;
    }
    body.dark{color:#e6eef8}

    /* Layout container */
    .wrap{
      max-width:var(--maxw);
      margin:20px auto;
      padding:18px;
    }

    /* Topbar */
    .topbar{
      position:sticky; top:10px; z-index:60;
      display:flex; gap:12px; align-items:center;
      padding:12px; border-radius:14px;
      background: linear-gradient(180deg, var(--glass), rgba(255,255,255,0.02));
      box-shadow:var(--elev);
      border:1px solid rgba(0,0,0,0.04);
      backdrop-filter: blur(8px) saturate(1.05);
      transition: transform .35s ease, opacity .35s ease;
    }
    body.dark .topbar{
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.03);
    }
    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:44px;height:44px;border-radius:10px;
      display:grid;place-items:center;font-weight:800;
      background: linear-gradient(135deg,var(--accent-1),var(--accent-2));
      color:#fff;box-shadow:0 6px 18px rgba(124,58,237,0.12);
      font-family:"Inter"; font-size:16px;
    }
    .brand h1{font-size:18px;margin:0;letter-spacing:-0.2px}
    .search-box{flex:1;min-width:140px}
    .search-box input{
      width:100%;padding:9px 12px;border-radius:10px;border:1px solid rgba(11,18,28,0.06);
      background:rgba(255,255,255,0.9);font-size:14px;color:inherit;
      outline:none;transition:box-shadow .18s ease, transform .12s ease;
    }
    body.dark .search-box input{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .search-box input:focus{box-shadow:0 6px 22px rgba(33,99,255,0.08); transform:translateY(-1px)}
    .controls{display:flex;gap:8px;align-items:center}
    .icon-btn{
      height:42px;padding:0 12px;border-radius:10px;border:none;background:transparent;color:inherit;
      display:inline-flex;align-items:center;gap:8px;cursor:pointer;font-weight:600;
      transition:transform .12s, box-shadow .12s;
    }
    .icon-btn:hover{transform:translateY(-3px); box-shadow: 0 8px 20px rgba(33,99,255,0.06)}
    .mode-toggle{display:inline-flex;align-items:center;gap:8px;padding:8px;border-radius:10px;background:linear-gradient(90deg, rgba(33,99,255,0.06), rgba(124,58,237,0.04));border:1px solid rgba(11,18,28,0.04)}
    .profile-btn{width:42px;height:42px;border-radius:10px;border:1px solid rgba(11,18,28,0.06);display:grid;place-items:center;background:transparent;color:var(--accent-1);font-size:18px}

    /* Feed */
    .feed{margin-top:18px;display:flex;flex-direction:column;gap:16px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:14px;
      border:1px solid rgba(11,18,28,0.05);
      box-shadow:var(--elev);
      transition: transform .22s ease, box-shadow .22s ease;
      overflow:hidden;
    }
    body.dark .card{ border:1px solid rgba(255,255,255,0.03) }

    .card:hover{ transform: translateY(-6px); box-shadow: 0 22px 46px rgba(11,18,28,0.12); }

    .post-header{display:flex;gap:12px;align-items:center}
    .uicon{
      width:48px;height:48px;border-radius:10px;display:grid;place-items:center;font-weight:800;color:#fff;
      font-size:18px;
      background:linear-gradient(135deg,var(--accent-1),var(--accent-2));
      box-shadow: 0 8px 30px rgba(33,99,255,0.08);
    }
    .meta{display:flex;flex-direction:column}
    .username{font-weight:700;font-size:15px;color:inherit}
    .time{font-size:12px;color:var(--muted)}

    .caption{margin-top:12px;line-height:1.5;font-size:15px;color:inherit}
    .post-image{width:100%;max-height:480px;object-fit:cover;border-radius:10px;margin-top:12px;display:block;box-shadow:0 8px 30px rgba(11,18,28,0.06)}

    /* prompt block */
    .prompt-block{
      margin-top:12px;padding:10px;border-radius:10px;display:flex;align-items:center;gap:12px;
      background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
      border:1px solid rgba(11,18,28,0.04);
      font-family: "Share Tech Mono", monospace;
      font-size:13px;color: #0b1220;
    }
    body.dark .prompt-block{ color: #cfe8ff }
    .prompt-text{flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-copy{padding:8px 12px;border-radius:8px;border:none;background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;cursor:pointer;font-weight:700;letter-spacing:0.2px}

    /* actions */
    .actions{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn-react{
      display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:20px;border:1px solid rgba(11,18,28,0.05);
      background:transparent;cursor:pointer;font-weight:600;
    }
    .btn-react.active{background:linear-gradient(90deg,var(--accent-1),var(--accent-2));color:#fff;border-color:transparent;box-shadow:0 10px 28px rgba(124,58,237,0.08)}

    /* ad */
    .ad-card{padding:0;border-radius:10px;overflow:hidden;border:1px solid rgba(11,18,28,0.04)}
    .ad-card img{width:100%;display:block;height:auto}

    /* states */
    .loading, .empty{padding:18px;text-align:center;color:var(--muted);font-size:14px}

    /* responsive */
    @media(max-width:760px){
      .wrap{padding:12px}
      .topbar{flex-direction:column;align-items:stretch;gap:10px}
      .brand h1{font-size:16px}
    }
  </style>
</head>
<body class="">

  <div class="wrap">
    <header class="topbar" id="topbar">
      <div class="brand">
        <div class="logo">PS</div>
        <div>
          <h1 style="margin:0;font-size:16px">Prompt-Scientist</h1>
          <div style="font-size:12px;color:var(--muted);margin-top:2px">Feed • Latest prompts & examples</div>
        </div>
      </div>

      <div class="search-box">
        <input id="searchInput" placeholder="Search by text or author..." type="search" />
      </div>

      <div class="controls">
        <button class="icon-btn mode-toggle" id="modeBtn" title="Toggle theme">🌗</button>
        <button class="icon-btn profile-btn" id="profileBtn" title="Profile">👤</button>
      </div>
    </header>

    <main>
      <section id="feed" class="feed" aria-live="polite"></section>
      <div id="loading" class="loading">Loading posts…</div>
      <div id="endMsg" class="empty" style="display:none">No more posts</div>
    </main>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ---------- Firebase config (keep yours) ----------
    const firebaseConfig = {
      apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain:"prompt-scientist.firebaseapp.com",
      projectId:"prompt-scientist",
      storageBucket:"prompt-scientist.firebasestorage.app",
      messagingSenderId:"240705146800",
      appId:"1:240705146800:web:e7f05107761f4d3007d075"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    // ---------- DOM ----------
    const feedEl    = document.getElementById("feed");
    const loadingEl = document.getElementById("loading");
    const endMsgEl  = document.getElementById("endMsg");
    const profileBtn= document.getElementById("profileBtn");
    const topbar    = document.getElementById("topbar");
    const searchInput = document.getElementById("searchInput");
    const modeBtn     = document.getElementById("modeBtn");

    // ---------- State ----------
    let posts = [];     // loaded posts array
    let ads = [];
    let user = null;
    let currentIndex = 0;
    const PAGE_SIZE = 6;
    const userCache = {}; // uid -> name

    // Utility helpers
    const randomColor = ()=> ["#2563eb","#dc2626","#16a34a","#9333ea","#ea580c","#0d9488"][Math.floor(Math.random()*6)];
    const escapeHtml = (s="") => String(s).replace(/[&<>]/g, ch=> ({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]));
    const timeAgo = ts=>{
      try{
        const d = ts?.toDate ? ts.toDate() : new Date(ts);
        const sec = (Date.now() - d) / 1000;
        if(sec < 60) return `${Math.floor(sec)}s`;
        if(sec < 3600) return `${Math.floor(sec/60)}m`;
        if(sec < 86400) return `${Math.floor(sec/3600)}h`;
        return `${Math.floor(sec/86400)}d`;
      }catch{return "";}
    };
    const shuffle = a => { for(let i=a.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [a[i],a[j]]=[a[j],a[i]] } return a; };

    // ---------- Load users: prefer `name` field ----------
    async function loadUsersForPosts(uids){
      const toLoad = uids.filter(uid => uid && !userCache[uid]);
      if(toLoad.length === 0) return;
      await Promise.all(toLoad.map(async uid=>{
        try{
          const snap = await getDoc(doc(db, "users", uid));
          if(snap.exists()){
            const data = snap.data();
            // Prefer `name` field (as you requested). fallback to username then Unknown.
            const name = (data.name && String(data.name).trim()) ? String(data.name).trim()
                        : (data.username && String(data.username).trim()) ? String(data.username).trim()
                        : null;
            userCache[uid] = name || "Unknown";
          } else {
            userCache[uid] = "Unknown";
          }
        }catch(err){
          console.error("loadUsersForPosts error", err);
          userCache[uid] = "Unknown";
        }
      }));
    }

    // ---------- Load posts & ads ----------
    async function loadData(){
      loadingEl.style.display = "block";
      feedEl.innerHTML = "";
      endMsgEl.style.display = "none";
      currentIndex = 0;

      try{
        // fetch posts approved == true
        const snap = await getDocs(query(collection(db,"posts"), where("approved","==", true)));
        const fetched = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // Determine uid field robustly (support uid, userId, author)
        const uids = Array.from(new Set(fetched.map(p => (p.uid || p.userId || p.author || null)).filter(Boolean)));
        await loadUsersForPosts(uids); // fills userCache for those uids

        posts = shuffle(fetched.map(p=>{
          const uidField = p.uid || p.userId || p.author || null;
          return {
            id: p.id,
            caption: p.caption || "",
            prompt: p.prompt || "",
            imageURL: p.imageURL || "",
            timestamp: p.timestamp || null,
            uid: uidField,
            reactions: p.reactions || {},
            // fill name from userCache (we loaded above)
            name: (uidField ? userCache[uidField] : null) || "Unknown",
            color: randomColor()
          };
        }));

        // load ads (optional)
        const snapAds = await getDocs(collection(db,"ads"));
        ads = snapAds.docs.map(d => ({ id: d.id, ...d.data() }));

        renderNext();
      }catch(err){
        console.error("loadData error", err);
      }finally{
        loadingEl.style.display = "none";
      }
    }

    // ---------- Render pagination ----------
    function renderNext(){
      if(currentIndex >= posts.length){
        endMsgEl.style.display = "block";
        return;
      }
      const frag = document.createDocumentFragment();
      const end = Math.min(currentIndex + PAGE_SIZE, posts.length);
      for(let i = currentIndex; i < end; i++){
        frag.appendChild(renderPost(posts[i]));
      }
      // occasionally insert an ad (random)
      if(ads.length && Math.random() < 0.35){
        frag.appendChild(renderAd(ads[Math.floor(Math.random()*ads.length)]));
      }
      feedEl.appendChild(frag);
      currentIndex = end;
    }

    // ---------- Render single post ----------
    function renderPost(p){
      const reactions = p.reactions || {};
      const myReact = user ? reactions[user.uid] : null;

      // compute counts
      const counts = { like:0, love:0, haha:0, angry:0, wow:0 };
      Object.values(reactions).forEach(r => { if(counts[r] !== undefined) counts[r]++; });

      const el = document.createElement("article");
      el.className = "card post";
      el.dataset.id = p.id;

      // Use name from posts[{name}] (which we set from userCache), and ensure we show correct initial
      const displayName = p.name || (p.uid ? userCache[p.uid] : null) || "Unknown";
      const initial = (displayName && displayName[0]) ? displayName[0].toUpperCase() : "U";

      el.innerHTML = `
        <div class="post-header">
          <div class="uicon" style="background:${p.color}">${escapeHtml(initial)}</div>
          <div class="meta">
            <div class="username">${escapeHtml(displayName)}</div>
            <div class="time">${timeAgo(p.timestamp)}</div>
          </div>
        </div>

        <div class="caption">${escapeHtml(p.caption)}</div>
        ${p.imageURL ? `<img class="post-image" src="${escapeHtml(p.imageURL)}" alt="post image">` : ""}

        <div class="prompt-block">
          <div class="prompt-text" title="${escapeHtml(p.prompt||"")}">${escapeHtml(p.prompt)}</div>
          <button class="btn-copy" data-prompt="${escapeHtml(p.prompt||"")}">Copy</button>
        </div>

        <div class="actions">
          ${reactionBtn("like","👍",counts.like,myReact)}
          ${reactionBtn("love","❤️",counts.love,myReact)}
          ${reactionBtn("haha","😂",counts.haha,myReact)}
          ${reactionBtn("angry","😡",counts.angry,myReact)}
          ${reactionBtn("wow","😮",counts.wow,myReact)}
        </div>
      `;
      return el;
    }

    const reactionBtn = (type, emoji, count, my) => 
      `<button class="btn-react ${my===type ? "active":""}" data-type="${type}">
        <span>${emoji}</span> <span class="count">${count}</span>
      </button>`;

    function renderAd(a){
      const el = document.createElement("div");
      el.className = "card ad-card";
      el.innerHTML = `
        <div style="padding:12px 14px">
          <div class="sponsored" style="color:var(--muted);font-size:12px;margin-bottom:8px">Sponsored</div>
          <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noopener" style="display:block">
            <img src="${escapeHtml(a.imageURL||"")}" alt="ad">
          </a>
        </div>
      `;
      return el;
    }

    // ---------- Event handling ----------
    feedEl.addEventListener("click", async (ev) => {
      const copyBtn = ev.target.closest(".btn-copy");
      if(copyBtn){
        try{
          await navigator.clipboard.writeText(copyBtn.dataset.prompt || "");
          copyBtn.textContent = "Copied!";
          setTimeout(()=> copyBtn.textContent = "Copy", 1200);
        }catch(err){
          alert("Copy failed");
        }
        return;
      }

      const reactBtn = ev.target.closest(".btn-react");
      if(reactBtn){
        if(!user){
          alert("Login required");
          return;
        }
        const postEl = reactBtn.closest(".post");
        const postId = postEl.dataset.id;
        const chosen = reactBtn.dataset.type;

        try{
          // update DB
          await updateDoc(doc(db, "posts", postId), { [`reactions.${user.uid}`]: chosen });

          // update local model (posts array) to keep UI consistent and update counts properly
          const p = posts.find(x => x.id === postId);
          if(p){
            p.reactions = p.reactions || {};
            p.reactions[user.uid] = chosen;
            // re-render counts in DOM for this post only
            updateReactionUI(postEl, p.reactions, user.uid);
          }
        }catch(err){
          console.error("Reaction update error", err);
        }
      }
    });

    // Update reaction counts/UI from a reactions object
    function updateReactionUI(postEl, reactionsObj, myUid){
      const counts = { like:0, love:0, haha:0, angry:0, wow:0 };
      Object.values(reactionsObj || {}).forEach(r => { if(counts[r] !== undefined) counts[r]++; });

      postEl.querySelectorAll(".btn-react").forEach(btn=>{
        const type = btn.dataset.type;
        btn.classList.toggle("active", reactionsObj && reactionsObj[myUid] === type);
        const cntSpan = btn.querySelector(".count");
        if(cntSpan) cntSpan.textContent = counts[type] || 0;
      });
    }

    // Search filter
    searchInput.addEventListener("input", ()=>{
      const t = searchInput.value.trim().toLowerCase();
      feedEl.querySelectorAll(".post").forEach(p=>{
        const caption = p.querySelector(".caption")?.textContent?.toLowerCase() || "";
        const username = p.querySelector(".username")?.textContent?.toLowerCase() || "";
        p.style.display = (caption.includes(t) || username.includes(t)) ? "" : "none";
      });
    });

    // Infinite scroll & topbar hide
    window.addEventListener("scroll", ()=>{
      if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 260){
        renderNext();
      }
    });

    let lastY = 0;
    window.addEventListener("scroll", ()=>{
      const y = window.scrollY;
      if(y > lastY && y > 80) topbar.style.transform = "translateY(-18px)";
      else topbar.style.transform = "translateY(0)";
      lastY = y;
    });

    profileBtn.addEventListener("click", ()=> location.href = "profile.html");

    // theme toggle
    modeBtn.addEventListener("click", ()=>{
      document.body.classList.toggle("dark");
      const isDark = document.body.classList.contains("dark");
      try{ localStorage.setItem("ps_theme_dark", isDark ? "1" : "0"); }catch(e){}
    });

    // load stored theme on init
    (function initTheme(){
      try{
        const prefer = localStorage.getItem("ps_theme_dark");
        if(prefer === "1") document.body.classList.add("dark");
      }catch(e){}
    })();

    // ---------- Auth & start ----------
    onAuthStateChanged(auth, async (u) => {
      if(u){
        user = { uid: u.uid, email: u.email };
        await loadData();
      }else{
        // if you want public feed even without login, keep loadData
        await loadData();
      }
    });

  </script>
</body>
  </html>
