<!doctype html>

<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt-Scientist ‚Äî Feed</title>
  <style>
    :root{
      --bg:#f3f4f6; --card:#ffffff; --muted:#6b7280; --accent:#2563eb; --radius:12px; --shadow:0 8px 24px rgba(16,24,40,0.06); --maxw:980px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,'Noto Sans',Arial;background:var(--bg);color:#0f172a}/* Topbar */
header{position:fixed;top:0;left:50%;transform:translateX(-50%);width:100%;max-width:var(--maxw);z-index:1200;background:var(--card);border-bottom:1px solid #e6eefc;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px;transition:transform .32s ease,opacity .32s ease}
header.hidden{transform:translateX(-50%) translateY(-110%);opacity:0}
.brand{font-size:22px;font-weight:800;color:var(--accent)}
.header-actions{display:flex;align-items:center;gap:12px}
.search-input{padding:8px 10px;border-radius:8px;border:1px solid #e6eefc;width:220px}
.profile-btn{width:40px;height:40px;border-radius:999px;background:#fff;border:1px solid #eef2ff;display:grid;place-items:center;cursor:pointer}

/* Layout */
main{max-width:var(--maxw);margin:84px auto 80px;padding:0 16px}
.feed{display:flex;flex-direction:column;gap:16px}
.card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #eef6ff;box-shadow:var(--shadow)}

/* Post */
.post-header{display:flex;gap:12px;align-items:center}
.avatar{width:44px;height:44px;border-radius:50%;background:#eef6ff;display:grid;place-items:center;font-weight:700;color:var(--accent)}
.meta{display:flex;flex-direction:column}
.author{font-weight:700}
.time{font-size:12px;color:var(--muted)}
.caption{margin-top:10px;white-space:pre-wrap;line-height:1.45}
.post-image{width:100%;max-height:520px;object-fit:cover;margin-top:12px;border-radius:10px}

/* prompt & copy */
.prompt-wrap{position:relative;margin-top:12px;background:#f8fafc;border:1px solid #eef2ff;padding:10px;border-radius:8px;font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace}
.copy-btn{position:absolute;top:8px;right:8px;background:var(--accent);color:#fff;border:none;padding:6px 8px;border-radius:8px;cursor:pointer;font-size:13px}
.copy-tooltip{position:absolute;top:-30px;right:8px;background:#111827;color:#fff;padding:6px 8px;border-radius:6px;font-size:12px;opacity:0;transform:translateY(-4px);transition:opacity .18s,transform .18s}
.copy-tooltip.show{opacity:1;transform:translateY(0)}

/* reactions */
.reactions{display:flex;gap:12px;margin-top:12px}
.reaction{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;padding:8px;border-radius:10px;border:1px solid #eef6ff;background:#fff;cursor:pointer;min-width:56px}
.reaction.active{background:#eef2ff;border-color:var(--accent);color:var(--accent)}
.reaction-emoji{font-size:18px}
.reaction-count{font-size:13px;color:var(--muted)}

/* ad */
.ad-card img{width:100%;height:auto;border-radius:10px;display:block}

.loading{text-align:center;padding:18px;color:var(--muted)}
.empty{text-align:center;padding:28px;color:var(--muted)}

@media (max-width:720px){
  header{padding:10px 12px}
  .search-input{width:140px}
  .brand{font-size:18px}
  main{margin-top:72px}
}

  </style>
</head>
<body>
  <header id="topbar">
    <div class="brand">Prompt-Scientist</div>
    <div class="header-actions">
      <input id="search" class="search-input" placeholder="Search caption..." aria-label="Search posts by caption" />
      <button id="profileBtn" class="profile-btn" aria-label="Profile">üë§</button>
    </div>
  </header>  <main>
    <div id="feed" class="feed" aria-live="polite"></div>
    <div id="loading" class="loading">Loading posts‚Ä¶</div>
    <div id="endMsg" class="empty" style="display:none">No more posts</div>
  </main>  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs,
      doc, updateDoc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // Firebase config (provided)
    const firebaseConfig = {
      apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain: "prompt-scientist.firebaseapp.com",
      projectId: "prompt-scientist",
      storageBucket: "prompt-scientist.firebasestorage.app",
      messagingSenderId: "240705146800",
      appId: "1:240705146800:web:e7f05107761f4d3007d075"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    const feedEl = document.getElementById('feed');
    const loadingEl = document.getElementById('loading');
    const endMsgEl = document.getElementById('endMsg');
    const searchEl = document.getElementById('search');
    const profileBtn = document.getElementById('profileBtn');
    const topbar = document.getElementById('topbar');

    const PAGE_SIZE = 6;
    const AD_INTERVAL = 3;
    let lastVisible = null;
    let loading = false;
    let user = null; // {uid,email,name}
    let ads = [];
    let loadedPosts = []; // posts loaded so far (for search & UI)
    let totalRendered = 0;

    const escapeHtml = s => String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const timeAgo = ts => {
      if(!ts) return '';
      const d = ts.toDate ? ts.toDate() : new Date(ts);
      const s = Math.floor((Date.now()-d.getTime())/1000);
      if(s<60) return s+'s'; if(s<3600) return Math.floor(s/60)+'m'; if(s<86400) return Math.floor(s/3600)+'h'; return Math.floor(s/86400)+'d';
    };

    // Wait for auth (or localStorage) and init
    (async function init(){
      const local = (()=>{ try{return JSON.parse(localStorage.getItem('ps_auth')||'null'); }catch(e){return null;} })();
      const firebaseUser = await new Promise(resolve => {
        const unsub = onAuthStateChanged(auth,u=>{ unsub(); resolve(u); });
      });
      if(!firebaseUser && !local){ location.href='index.html'; return; }
      user = local || { uid: firebaseUser.uid, email: firebaseUser.email };

      await loadAds();
      await loadPosts();

      // attach events
      window.addEventListener('scroll', onScroll);
      feedEl.addEventListener('click', onFeedClick);
      profileBtn.addEventListener('click', ()=> location.href='profile.html');
      searchEl.addEventListener('input', onSearch);

    })();

    // load ads
    async function loadAds(){
      try{
        const snap = await getDocs(collection(db,'ads'));
        ads = snap.docs.map(d => ({ id: d.id, ...d.data() }));
      }catch(e){ console.warn('ads load',e); ads = []; }
    }

    // load posts with pagination
    async function loadPosts(){
      if(loading) return; loading = true; loadingEl.style.display='block';
      try{
        // build query
        let q;
        if(!lastVisible){
          q = query(collection(db,'posts'), where('approved','==',true), orderBy('timestamp','desc'), limit(PAGE_SIZE));
        } else {
          q = query(collection(db,'posts'), where('approved','==',true), orderBy('timestamp','desc'), startAfter(lastVisible), limit(PAGE_SIZE));
        }
        const snap = await getDocs(q);
        if(snap.empty){ if(!lastVisible) feedEl.innerHTML = '<div class="empty">No approved posts yet.</div>'; else endMsgEl.style.display='block'; loading=false; loadingEl.style.display='none'; return; }
        lastVisible = snap.docs[snap.docs.length-1];

        // map docs
        const batch = snap.docs.map(d => ({ id: d.id, ...d.data() }));

        // collect missing userIds to resolve names (if posts don't already have name)
        const missing = Array.from(new Set(batch.filter(p => !p.name && p.userId).map(p => p.userId)));
        if(missing.length){
          // fetch users in chunks (Firestore "in" supports up to 10)
          const uidName = {};
          for(let i=0;i<missing.length;i+=10){
            const chunk = missing.slice(i,i+10);
            const qUsers = query(collection(db,'users'), where('uid','in', chunk));
            const snapU = await getDocs(qUsers);
            snapU.forEach(uDoc => { const d = uDoc.data(); uidName[d.uid] = d.name; });
          }
          batch.forEach(p => { if(!p.name && p.userId && uidName[p.userId]) p.name = uidName[p.userId]; });
        }

        // append to loadedPosts and render
        for(const p of batch){ loadedPosts.push(p); feedEl.appendChild(createPostElement(p)); totalRendered++;
          // inject ad after every AD_INTERVAL posts
          if(ads.length && (totalRendered % AD_INTERVAL === 0)){
            const ad = ads[Math.floor(Math.random()*ads.length)]; feedEl.appendChild(createAdElement(ad));
          }
        }

      }catch(err){ console.error('loadPosts', err); if(!lastVisible) feedEl.innerHTML = '<div class="empty">Error loading posts</div>'; }
      finally{ loading = false; loadingEl.style.display='none'; }
    }

    // create post DOM
    function createPostElement(p){
      const el = document.createElement('article'); el.className = 'card post'; el.dataset.id = p.id; el.dataset.caption = (p.caption||'').toLowerCase();
      const reactions = p.reactions || {};
      const getCount = (t) => Array.isArray(reactions[t]) ? reactions[t].length : 0;
      const userReacted = (t) => Array.isArray(reactions[t]) && user && reactions[t].includes(user.uid);

      el.innerHTML = `
        <div class="post-header">
          <div style="display:flex;gap:12px;align-items:center">
            <div class="avatar">${escapeHtml((p.name||'U').slice(0,1).toUpperCase())}</div>
            <div class="meta">
              <div class="author">${escapeHtml(p.name || p.username || 'Unknown')}</div>
              <div class="time">${escapeHtml(timeAgo(p.timestamp))} ${p.timestamp?('‚Ä¢ '+new Date(p.timestamp.toDate()).toLocaleString()):''}</div>
            </div>
          </div>
        </div>
        <div class="caption">${escapeHtml(p.caption||'')}</div>
        ${p.imageURL?`<img loading="lazy" class="post-image" src="${escapeHtml(p.imageURL)}" alt="post image">`:''}
        <div class="prompt-wrap">
          <div class="copy-tooltip">Copied!</div>
          <div class="prompt-text">${escapeHtml(p.prompt||'')}</div>
          <button class="copy-btn" aria-label="Copy prompt">Copy</button>
        </div>
        <div class="reactions">
          <div class="reaction ${userReacted('like')? 'active' : ''}" data-type="like"><div class="reaction-emoji">üëç</div><div class="reaction-count">${getCount('like')}</div></div>
          <div class="reaction ${userReacted('haha')? 'active' : ''}" data-type="haha"><div class="reaction-emoji">üòÇ</div><div class="reaction-count">${getCount('haha')}</div></div>
          <div class="reaction ${userReacted('wow')? 'active' : ''}" data-type="wow"><div class="reaction-emoji">üòÆ</div><div class="reaction-count">${getCount('wow')}</div></div>
          <div class="reaction ${userReacted('angry')? 'active' : ''}" data-type="angry"><div class="reaction-emoji">üò°</div><div class="reaction-count">${getCount('angry')}</div></div>
        </div>
      `;
      return el;
    }

    function createAdElement(a){
      const el = document.createElement('div'); el.className = 'card ad-card';
      const img = document.createElement('img'); img.src = a.imageURL || ''; img.alt = 'ad'; img.onclick = ()=> window.open(a.link||'#','_blank');
      el.appendChild(img); return el;
    }

    // click handlers (delegated)
    async function onFeedClick(e){
      const postEl = e.target.closest('.post');
      if(!postEl) return;
      const postId = postEl.dataset.id;

      // Copy prompt
      if(e.target.closest('.copy-btn')){
        const btn = e.target.closest('.copy-btn');
        const wrap = btn.closest('.prompt-wrap');
        const promptText = wrap.querySelector('.prompt-text').innerText || '';
        try{ await navigator.clipboard.writeText(promptText); const tip = wrap.querySelector('.copy-tooltip'); tip.classList.add('show'); setTimeout(()=>tip.classList.remove('show'),1200); }catch(err){ alert('Copy failed'); }
        return;
      }

      // Reaction
      const reactionEl = e.target.closest('.reaction');
      if(reactionEl){
        const type = reactionEl.dataset.type;
        const postRef = doc(db,'posts',postId);
        const userId = user.uid;
        const active = reactionEl.classList.contains('active');
        // optimistic UI
        const countEl = reactionEl.querySelector('.reaction-count');
        let cnt = parseInt(countEl.innerText||'0',10);
        if(active){ cnt = Math.max(0,cnt-1); reactionEl.classList.remove('active'); }
        else { cnt = cnt+1; reactionEl.classList.add('active'); }
        countEl.innerText = cnt;
        // commit to Firestore
        try{
          if(active) await updateDoc(postRef, { [`reactions.${type}`]: arrayRemove(userId) });
          else await updateDoc(postRef, { [`reactions.${type}`]: arrayUnion(userId) });
        }catch(err){ console.error('reaction error',err); alert('Could not send reaction'); }
        return;
      }
    }

    // scroll -> load more and header hide/show
    let lastY = 0; let ticking = false;
    function onScroll(){
      if(!ticking){ window.requestAnimationFrame(()=>{
        const y = window.scrollY;
        if(y > lastY && y > 60) topbar.classList.add('hidden'); else topbar.classList.remove('hidden');
        lastY = y;
        // near bottom -> load more
        if(window.innerHeight + window.scrollY >= document.body.offsetHeight - 1200) loadPosts();
        ticking = false;
      }); ticking = true; }
    }

    // search
    function onSearch(){
      const term = (searchEl.value||'').trim().toLowerCase();
      const cards = feedEl.querySelectorAll('.post');
      cards.forEach(c=>{ const cap = c.dataset.caption || ''; c.style.display = term? (cap.includes(term)? 'block' : 'none') : 'block'; });
    }

  </script></body>
</html>