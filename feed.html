<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prompt-Scientist ‚Äî Feed</title>
  <style>
    :root{
      --bg:#f9fafb;--fg:#111827;--card:#fff;--border:#e5e7eb;
      --accent:#2563eb;--accent-hover:#1e40af;
      --muted:#6b7280;--tooltip:#374151;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,sans-serif;background:var(--bg);color:var(--fg);}
    header{position:fixed;top:0;left:0;right:0;background:var(--card);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:10px 16px;z-index:1000;transition:transform .3s;}
    header.hidden{transform:translateY(-100%);}
    .brand{font-size:22px;font-weight:700;color:var(--accent);}
    .actions{display:flex;align-items:center;gap:12px;}
    .search{padding:6px 10px;border:1px solid var(--border);border-radius:6px;font-size:14px;}
    .profile{width:36px;height:36px;border-radius:50%;background:var(--border);cursor:pointer;}

    main{max-width:600px;margin:80px auto 40px;display:flex;flex-direction:column;gap:16px;padding:0 10px;}
    .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:12px;box-shadow:0 1px 3px rgba(0,0,0,0.05);}
    .post-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px;}
    .post-user{font-weight:600;}
    .post-time{font-size:12px;color:var(--muted);}
    .caption{margin:8px 0;font-size:15px;}
    .post-img{width:100%;border-radius:10px;margin:8px 0;object-fit:cover;}
    .prompt-box{background:#f3f4f6;border:1px solid var(--border);padding:10px;border-radius:8px;position:relative;margin-top:8px;font-family:monospace;font-size:14px;word-wrap:break-word;}
    .copy-btn{position:absolute;top:6px;right:6px;background:var(--accent);color:#fff;border:none;border-radius:6px;padding:4px 8px;font-size:12px;cursor:pointer;transition:.2s;}
    .copy-btn:hover{background:var(--accent-hover);}
    .tooltip{position:absolute;top:-24px;right:6px;background:var(--tooltip);color:#fff;padding:2px 6px;border-radius:4px;font-size:11px;opacity:0;pointer-events:none;transition:opacity .2s;}
    .tooltip.show{opacity:1;}

    .reactions{display:flex;gap:20px;margin-top:8px;}
    .reaction{display:flex;flex-direction:column;align-items:center;font-size:20px;cursor:pointer;color:var(--muted);transition:.2s;}
    .reaction.active{color:var(--accent);}
    .reaction span{font-size:12px;margin-top:2px;}

    .ad-card img{width:100%;border-radius:10px;cursor:pointer;}
    @media(max-width:640px){
      .brand{font-size:18px;}
      .search{max-width:120px;}
    }
  </style>
</head>
<body>
<header id="header">
  <div class="brand">Prompt-Scientist</div>
  <div class="actions">
    <input id="search" class="search" placeholder="Search..."/>
    <div class="profile" onclick="location.href='profile.html'"></div>
  </div>
</header>
<main id="feed"></main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
  import { getFirestore, collection, query, where, orderBy, limit, startAfter, getDocs, doc, updateDoc, arrayUnion, arrayRemove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

  const firebaseConfig={apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",authDomain:"prompt-scientist.firebaseapp.com",projectId:"prompt-scientist",storageBucket:"prompt-scientist.firebasestorage.app",messagingSenderId:"240705146800",appId:"1:240705146800:web:e7f05107761f4d3007d075"};
  const app=initializeApp(firebaseConfig);
  const auth=getAuth(app);
  const db=getFirestore(app);

  // Auth check
  onAuthStateChanged(auth,u=>{
    if(!u){ location.href="index.html"; }
  });

  const feedEl=document.getElementById('feed');
  let lastVisible=null; let loading=false; let ads=[]; let posts=[];
  const PAGE_SIZE=5,AD_INTERVAL=3;

  // Load ads
  async function loadAds(){
    const snap=await getDocs(collection(db,'ads'));
    ads=snap.docs.map(d=>({id:d.id,...d.data()}));
  }
  function renderAd(ad){
    const div=document.createElement('div');div.className='card ad-card';
    const img=document.createElement('img');img.src=ad.imageURL;img.onclick=()=>window.open(ad.link,'_blank');
    div.appendChild(img);return div;
  }

  function renderPost(p,id){
    const div=document.createElement('div');div.className='card';
    div.innerHTML=`
      <div class="post-header">
        <div class="post-user">${p.name||'Unknown'}</div>
        <div class="post-time">${p.timestamp?.toDate().toLocaleString()||''}</div>
      </div>
      <div class="caption">${p.caption||''}</div>
      ${p.imageURL?`<img src="${p.imageURL}" class="post-img"/>`:''}
      <div class="prompt-box">
        <div class="tooltip">Copied!</div>
        ${p.prompt||''}
        <button class="copy-btn">Copy</button>
      </div>
      <div class="reactions">
        <div class="reaction" data-type="like">üëç<span>${(p.reactions?.like?.length)||0}</span></div>
        <div class="reaction" data-type="haha">üòÇ<span>${(p.reactions?.haha?.length)||0}</span></div>
        <div class="reaction" data-type="wow">üòÆ<span>${(p.reactions?.wow?.length)||0}</span></div>
        <div class="reaction" data-type="angry">üò°<span>${(p.reactions?.angry?.length)||0}</span></div>
      </div>
    `;
    // Copy
    const btn=div.querySelector('.copy-btn'),tooltip=div.querySelector('.tooltip');
    btn.onclick=()=>{navigator.clipboard.writeText(p.prompt||'');tooltip.classList.add('show');setTimeout(()=>tooltip.classList.remove('show'),1200);}
    // Reactions
    div.querySelectorAll('.reaction').forEach(r=>{
      r.onclick=async ()=>{
        const type=r.dataset.type;const postRef=doc(db,'posts',id);
        const userId=auth.currentUser.uid;
        const has=p.reactions?.[type]?.includes(userId);
        await updateDoc(postRef,{[`reactions.${type}`]:has?arrayRemove(userId):arrayUnion(userId)});
        r.classList.toggle('active',!has);
        const countEl=r.querySelector('span');countEl.innerText=parseInt(countEl.innerText)+(has?-1:1);
      }
    });
    return div;
  }

  async function loadPosts(){
    if(loading) return; loading=true;
    let q=query(collection(db,'posts'),where('approved','==',true),orderBy('timestamp','desc'),limit(PAGE_SIZE));
    if(lastVisible) q=query(q,startAfter(lastVisible));
    const snap=await getDocs(q);
    if(snap.empty){loading=false;return;}
    lastVisible=snap.docs[snap.docs.length-1];
    snap.forEach((docSnap,i)=>{
      const d=docSnap.data();
      posts.push({id:docSnap.id,...d});
      feedEl.appendChild(renderPost(d,docSnap.id));
      if(ads.length && ((posts.length)%AD_INTERVAL===0)){
        const ad=ads[Math.floor(Math.random()*ads.length)];
        feedEl.appendChild(renderAd(ad));
      }
    });
    loading=false;
  }

  // Infinite scroll
  window.addEventListener('scroll',()=>{
    if(window.innerHeight+window.scrollY>=document.body.offsetHeight-100){ loadPosts(); }
  });

  // Header hide/show
  let lastScroll=0;const header=document.getElementById('header');
  window.addEventListener('scroll',()=>{
    const y=window.scrollY;
    if(y>lastScroll && y>60){header.classList.add('hidden');}
    else{header.classList.remove('hidden');}
    lastScroll=y;
  });

  // Search
  document.getElementById('search').addEventListener('input',e=>{
    const term=e.target.value.toLowerCase();feedEl.innerHTML='';
    posts.filter(p=>(p.caption||'').toLowerCase().includes(term)).forEach(p=>feedEl.appendChild(renderPost(p,p.id)));
  });

  await loadAds(); await loadPosts();
</script>
</body>
</html>