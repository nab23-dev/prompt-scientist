<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>AI Feed</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    :root {
      --bg-light: #f9fafb;
      --bg-dark: #0d1117;
      --text-light: #1f2937;
      --text-dark: #e5e7eb;
      --card-light: #ffffffcc;
      --card-dark: #161b22cc;
      --accent: #00f0ff;
      --neon: 0 0 10px var(--accent), 0 0 20px var(--accent), 0 0 40px var(--accent);
    }
    body {
      margin: 0;
      font-family: "Segoe UI", Roboto, sans-serif;
      transition: background 0.3s, color 0.3s;
    }
    body.light { background: var(--bg-light); color: var(--text-light); }
    body.dark  { background: var(--bg-dark);  color: var(--text-dark); }

    /* === Topbar === */
    .topbar {
      position: sticky;
      top: 0; z-index: 1000;
      display: flex; align-items: center;
      justify-content: space-between;
      padding: 12px 16px;
      backdrop-filter: blur(10px);
      transition: transform 0.3s;
    }
    body.light .topbar { background: #ffffffaa; }
    body.dark  .topbar { background: #0d1117aa; border-bottom: 1px solid #222; }
    .topbar.hide { transform: translateY(-100%); }

    .topbar input {
      flex: 1;
      margin: 0 12px;
      padding: 8px 12px;
      border-radius: 6px;
      border: none;
      outline: none;
    }
    body.light .topbar input { background: #f3f4f6; color: #111; }
    body.dark  .topbar input { background: #1f2937; color: #eee; }

    .btn {
      background: var(--accent);
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
      color: #000;
      font-weight: bold;
      transition: all 0.3s;
    }
    .btn:hover { box-shadow: var(--neon); }

    /* === Feed === */
    .feed {
      max-width: 720px;
      margin: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 18px;
    }
    .card {
      border-radius: 10px;
      padding: 16px;
      transition: all 0.3s ease;
      backdrop-filter: blur(6px);
    }
    body.light .card { background: var(--card-light); }
    body.dark  .card { background: var(--card-dark); border: 1px solid #222; }

    .card:hover { transform: translateY(-2px); box-shadow: var(--neon); }

    /* === Post === */
    .post-header { display: flex; align-items: center; margin-bottom: 10px; }
    .uicon {
      width: 40px; height: 40px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center;
      font-weight: bold; color: #fff; margin-right: 10px;
    }
    .username { font-weight: bold; }
    .time { font-size: 12px; opacity: 0.7; }
    .caption { margin: 8px 0; font-size: 15px; }
    .post-image { max-width: 100%; border-radius: 8px; margin: 10px 0; }

    /* === Prompt === */
    .prompt-block {
      display: flex; justify-content: space-between; align-items: center;
      background: rgba(0,255,255,0.05);
      border: 1px dashed var(--accent);
      padding: 6px 10px;
      border-radius: 6px;
      margin-top: 8px;
    }
    .prompt-text { flex: 1; word-break: break-word; }
    .btn-copy { background: transparent; color: var(--accent); border: none; cursor: pointer; font-weight: bold; }
    .btn-copy:hover { text-shadow: var(--neon); }

    /* === Actions === */
    .actions { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
    .btn-react {
      border: none; padding: 4px 8px; border-radius: 6px;
      cursor: pointer; background: transparent; font-size: 14px;
      display: flex; align-items: center; gap: 4px;
    }
    .btn-react.active { background: var(--accent); color: #000; font-weight: bold; }

    /* === Ads === */
    .ad-card img { max-width: 100%; border-radius: 6px; }
    .sponsored { font-size: 12px; opacity: 0.6; display: block; margin-bottom: 6px; }

    /* === Misc === */
    .loading, .endMsg { text-align: center; padding: 20px; opacity: 0.7; }
    .toggle-mode { margin-left: 10px; }
  </style>
</head>
<body class="dark">
  <div class="topbar" id="topbar">
    <button class="btn" id="profileBtn">Profile</button>
    <input type="text" id="searchInput" placeholder="üîç Search...">
    <button class="btn toggle-mode" id="modeBtn">‚òÄÔ∏è/üåô</button>
  </div>

  <main class="feed" id="feed"></main>
  <div class="loading" id="loading">Loading...</div>
  <div class="endMsg" id="endMsg">üöÄ End of feed</div>

  <!-- Firebase + Script -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain:"prompt-scientist.firebaseapp.com",
      projectId:"prompt-scientist",
      storageBucket:"prompt-scientist.firebasestorage.app",
      messagingSenderId:"240705146800",
      appId:"1:240705146800:web:e7f05107761f4d3007d075"
    };
    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getFirestore(app);

    const feedEl=document.getElementById("feed");
    const loadingEl=document.getElementById("loading");
    const endMsgEl=document.getElementById("endMsg");
    const profileBtn=document.getElementById("profileBtn");
    const topbar=document.getElementById("topbar");
    const searchInput=document.getElementById("searchInput");
    const modeBtn=document.getElementById("modeBtn");

    let posts=[],ads=[],user=null,currentIndex=0;
    const PAGE_SIZE=6;
    const userCache={};

    const randomColor=()=>["#2563eb","#dc2626","#16a34a","#9333ea","#ea580c","#0d9488"][Math.floor(Math.random()*6)];
    const escapeHtml=(s="")=>s.replace(/[&<>]/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]));
    const timeAgo=ts=>{try{const d=ts?.toDate?ts.toDate():new Date(ts);const sec=(Date.now()-d)/1000;if(sec<60)return`${Math.floor(sec)}s`;if(sec<3600)return`${Math.floor(sec/60)}m`;if(sec<86400)return`${Math.floor(sec/3600)}h`;return`${Math.floor(sec/86400)}d`;}catch{return"";}};
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;};

    async function loadUserName(uid){
      if(userCache[uid]) return userCache[uid];
      try{
        const snap=await getDoc(doc(db,"users",uid));
        if(snap.exists()){
          const d=snap.data();
          const name=d.username||d.name||"Unknown";
          userCache[uid]=name;
          return name;
        }
      }catch{}
      return "Unknown";
    }

    async function loadData(){
      loadingEl.style.display="block"; feedEl.innerHTML=""; endMsgEl.style.display="none"; currentIndex=0;
      try{
        const snap=await getDocs(query(collection(db,"posts"),where("approved","==",true)));
        posts=shuffle(await Promise.all(snap.docs.map(async d=>{
          const data=d.data();
          return {id:d.id,...data,name:await loadUserName(data.uid),color:randomColor()};
        })));
        const adsSnap=await getDocs(collection(db,"ads"));
        ads=adsSnap.docs.map(d=>({id:d.id,...d.data()}));
        renderNext();
      }finally{loadingEl.style.display="none";}
    }

    function renderNext(){
      if(currentIndex>=posts.length){endMsgEl.style.display="block";return;}
      const frag=document.createDocumentFragment();
      const end=Math.min(currentIndex+PAGE_SIZE,posts.length);
      for(let i=currentIndex;i<end;i++) frag.appendChild(renderPost(posts[i]));
      if(ads.length&&Math.random()<0.3) frag.appendChild(renderAd(ads[Math.floor(Math.random()*ads.length)]));
      feedEl.appendChild(frag); currentIndex=end;
    }

    function renderPost(p){
      const reactions=p.reactions||{}; const myReact=user?reactions[user.uid]:null;
      const counts={like:0,love:0,haha:0,angry:0,wow:0};
      Object.values(reactions).forEach(r=>counts[r]!==undefined&&counts[r]++);
      const el=document.createElement("article"); el.className="card post"; el.dataset.id=p.id;
      el.innerHTML=`
        <div class="post-header">
          <div class="uicon" style="background:${p.color}">${escapeHtml((p.name||"U")[0])}</div>
          <div><div class="username">${escapeHtml(p.name||"Unknown")}</div>
          <div class="time">${timeAgo(p.timestamp)}</div></div>
        </div>
        <div class="caption">${escapeHtml(p.caption||"")}</div>
        ${p.imageURL?`<img class="post-image" src="${escapeHtml(p.imageURL)}" alt="post">`:""}
        <div class="prompt-block"><div class="prompt-text">${escapeHtml(p.prompt||"")}</div>
        <button class="btn-copy" data-prompt="${escapeHtml(p.prompt||"")}">Copy</button></div>
        <div class="actions">
          ${reactionBtn("like","üëç",counts.like,myReact)}
          ${reactionBtn("love","‚ù§Ô∏è",counts.love,myReact)}
          ${reactionBtn("haha","üòÇ",counts.haha,myReact)}
          ${reactionBtn("angry","üò°",counts.angry,myReact)}
          ${reactionBtn("wow","üòÆ",counts.wow,myReact)}
        </div>`;
      return el;
    }

    const reactionBtn=(t,e,c,my)=>`<button class="btn-react ${my===t?"active":""}" data-type="${t}">
      <span>${e}</span> <span class="count">${c}</span></button>`;

    function renderAd(a){
      const el=document.createElement("div");
      el.className="card ad-card";
      el.innerHTML=`<span class="sponsored">Sponsored</span>
        <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noopener">
          <img src="${escapeHtml(a.imageURL||"")}" alt="ad">
        </a>`;
      return el;
    }

    // === Events ===
    feedEl.addEventListener("click",async e=>{
      const copy=e.target.closest(".btn-copy");
      if(copy){
        await navigator.clipboard.writeText(copy.dataset.prompt);
        copy.textContent="Copied!"; setTimeout(()=>copy.textContent="Copy",1200);
      }
      const react=e.target.closest(".btn-react");
      if(react&&user){
        const postEl=react.closest(".post"), id=postEl.dataset.id, type=react.dataset.type;
        await updateDoc(doc(db,"posts",id),{[`reactions.${user.uid}`]:type});
      }
    });

    searchInput.addEventListener("input",()=>{
      const term=searchInput.value.toLowerCase();
      feedEl.querySelectorAll(".post").forEach(p=>{
        const c=p.querySelector(".caption").textContent.toLowerCase();
        const u=p.querySelector(".username").textContent.toLowerCase();
        p.style.display=(c.includes(term)||u.includes(term))?"block":"none";
      });
    });

    window.addEventListener("scroll",()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-300) renderNext();});
    profileBtn.addEventListener("click",()=>location.href="profile.html");
    modeBtn.addEventListener("click",()=>document.body.classList.toggle("light"));

    let lastY=0;
    window.addEventListener("scroll",()=>{const y=window.scrollY;
      if(y>lastY&&y>60) topbar.classList.add("hide"); else topbar.classList.remove("hide"); lastY=y;});

    onAuthStateChanged(auth,u=>{if(u){user={uid:u.uid,email:u.email};loadData();}else{location.href="index.html";}});
  </script>
</body>
  </html>
