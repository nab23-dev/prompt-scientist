<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Prompt-Scientist ‚Äî Feed</title>
  <meta name="description" content="Prompt-Scientist feed ‚Äî browse approved prompts, like, copy prompts, and see ads."/>
  <style>
    :root{
      --bg: #f3f4f6;
      --card: #ffffff;
      --muted: #6b7280;
      --accent: #2563eb;
      --accent-2: #1e3a8a;
      --radius: 12px;
      --shadow: 0 8px 24px rgba(16,24,40,0.06);
      --maxw: 900px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter,system-ui,-apple-system,"Segoe UI",Roboto,'Noto Sans',Arial;background:var(--bg);color:#0f172a}
    .topbar{max-width:var(--maxw);margin:18px auto;padding:10px 18px;display:flex;align-items:center;justify-content:space-between;gap:12px}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:44px;height:44px;border-radius:10px;background:#fff;display:grid;place-items:center;font-weight:700;color:var(--accent);box-shadow:0 4px 12px rgba(16,24,40,0.04)}
    .brand h1{font-size:18px;margin:0}
    .profile-btn{width:40px;height:40px;border-radius:999px;background:#fff;border:1px solid #e6eefc;display:grid;place-items:center;cursor:pointer;box-shadow:0 4px 10px rgba(16,24,40,0.04)}
    .container{max-width:var(--maxw);margin:0 auto;padding:0 18px 80px;}
    .feed{margin-top:14px;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border-radius:12px;padding:14px;border:1px solid #eef2ff;box-shadow:var(--shadow)}
    .post-header{display:flex;gap:12px;align-items:center}
    .uicon{width:44px;height:44px;border-radius:50%;background:#eef2ff;display:grid;place-items:center;font-weight:700;color:var(--accent)}
    .meta{display:flex;flex-direction:column}
    .username{font-weight:700}
    .time{font-size:12px;color:var(--muted)}
    .caption{margin-top:10px;white-space:pre-wrap;line-height:1.45}
    .post-image{width:100%;max-height:520px;object-fit:cover;margin-top:12px;border-radius:10px}
    .prompt-block{margin-top:12px;padding:10px;border-radius:10px;background:#f8fafc;border:1px solid #eef2ff;display:flex;justify-content:space-between;gap:12px;align-items:center}
    .prompt-text{font-family:ui-monospace, SFMono-Regular, Menlo, Monaco, 'Roboto Mono', monospace;font-size:13px;color:#0f172a;overflow:hidden;text-overflow:ellipsis}
    .actions{display:flex;gap:10px;align-items:center;margin-top:12px}
    .btn-like{display:inline-flex;align-items:center;gap:8px;padding:8px 10px;border-radius:10px;border:1px solid #eef2ff;background:#fff;cursor:pointer}
    .btn-like .count{font-weight:600}
    .btn-copy{padding:8px 10px;border-radius:10px;border:none;background:var(--accent);color:#fff;cursor:pointer}
    .ad-card{padding:0;border:1px dashed #e6eefc;overflow:hidden}
    .ad-card img{width:100%;height:auto;display:block}
    .loading{padding:18px;text-align:center;color:var(--muted)}
    .empty{padding:28px;text-align:center;color:var(--muted)}
    @media(max-width:640px){ .container{padding:0 12px} .prompt-text{font-size:12px} .uicon{width:40px;height:40px} }
  </style>
</head>
<body>
  <header class="topbar">
    <div class="brand"><div class="logo">PS</div><h1>Prompt-Scientist</h1></div>
    <div style="display:flex;align-items:center;gap:12px">
      <button id="profileBtn" class="profile-btn" title="Profile" aria-label="Profile">üë§</button>
    </div>
  </header>

  <main class="container">
    <section id="feed" class="feed" aria-live="polite"></section>
    <div id="loading" class="loading">Loading posts‚Ä¶</div>
    <div id="endMsg" class="empty" style="display:none">No more posts</div>
  </main>

  <script type="module">
    // Firebase v11 imports
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import {
      getFirestore, collection, query, where, getDocs,
      updateDoc, doc, arrayUnion, arrayRemove
    } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    // ===== Your provided firebase config =====
    const firebaseConfig = {
      apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain: "prompt-scientist.firebaseapp.com",
      projectId: "prompt-scientist",
      storageBucket: "prompt-scientist.firebasestorage.app",
      messagingSenderId: "240705146800",
      appId: "1:240705146800:web:e7f05107761f4d3007d075"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    // DOM
    const feedEl = document.getElementById('feed');
    const loadingEl = document.getElementById('loading');
    const endMsgEl = document.getElementById('endMsg');
    const profileBtn = document.getElementById('profileBtn');

    // config
    const PAGE_SIZE = 6;           // posts per batch
    const AD_INTERVAL = 3;         // insert ad after every N posts
    let posts = [];                // shuffled posts array
    let ads = [];                  // ads array
    let currentIndex = 0;          // next post index to render
    let isLoading = false;
    let user = null;               // logged-in user (from localStorage or auth)

    // small helpers
    const escapeHtml = (s='') => String(s).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const timeAgo = ts => {
      try{
        const d = ts && ts.toDate ? ts.toDate() : new Date(ts);
        const sec = Math.floor((Date.now() - d.getTime())/1000);
        if(sec < 60) return `${sec}s`;
        if(sec < 3600) return `${Math.floor(sec/60)}m`;
        if(sec < 86400) return `${Math.floor(sec/3600)}h`;
        return `${Math.floor(sec/86400)}d`;
      }catch(e){ return ''; }
    };
    function shuffleArray(arr){
      for(let i=arr.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [arr[i],arr[j]] = [arr[j],arr[i]];
      }
      return arr;
    }

    // Auth check (client-side) ‚Äî require login to see feed
    function getLocalAuth(){
      try{ return JSON.parse(localStorage.getItem('ps_auth')||'null'); }catch(e){ return null; }
    }

    function requireAuthOrRedirect(){
      const ls = getLocalAuth();
      if(ls && ls.uid) { user = ls; return true; }
      // also check firebase auth
      return false;
    }

    // Load data: approved posts + ads
    async function loadData(){
      isLoading = true;
      loadingEl.style.display = 'block';
      feedEl.innerHTML = '';
      endMsgEl.style.display = 'none';
      currentIndex = 0;
      posts = [];
      try{
        // posts
        const postsRef = collection(db, 'posts');
        const q = query(postsRef, where('approved','==', true));
        const snap = await getDocs(q);
        const arr = snap.docs.map(d => ({ id: d.id, ...d.data() }));
        // shuffle for random order on refresh
        posts = shuffleArray(arr);

        // ads
        const adsRef = collection(db, 'ads');
        const snapAds = await getDocs(adsRef);
        ads = snapAds.docs.map(d => ({ id: d.id, ...d.data() }));

        if(posts.length === 0){
          feedEl.innerHTML = '<div class="empty">No approved posts yet.</div>';
          loadingEl.style.display = 'none';
          isLoading = false;
          return;
        }

        // render first batch
        renderNextBatch();
      }catch(err){
        console.error('Load error', err);
        feedEl.innerHTML = `<div class="empty">Error loading posts. Refresh page.</div>`;
      } finally {
        loadingEl.style.display = 'none';
        isLoading = false;
      }
    }

    // Render posts from currentIndex up to PAGE_SIZE
    function renderNextBatch(){
      if(currentIndex >= posts.length){
        endMsgEl.style.display = 'block';
        return;
      }
      const end = Math.min(currentIndex + PAGE_SIZE, posts.length);
      for(let i = currentIndex; i < end; i++){
        // render post
        const p = posts[i];
        feedEl.appendChild(createPostElement(p));
        // inject ad after every AD_INTERVAL posts
        if(ads.length && ((i - currentIndex + 1) % AD_INTERVAL === 0)){
          const ad = ads[Math.floor(Math.random() * ads.length)];
          feedEl.appendChild(createAdElement(ad));
        }
      }
      currentIndex = end;
      // if we've consumed all posts, show end message
      if(currentIndex >= posts.length) endMsgEl.style.display = 'block';
    }

    // Create Post DOM element
    function createPostElement(p){
      const el = document.createElement('article');
      el.className = 'card post';
      el.dataset.id = p.id;

      // calculate like count and whether user liked
      const likesArr = Array.isArray(p.likes) ? p.likes : [];
      const likeCount = likesArr.length;
      const userLiked = user && likesArr.includes(user.uid);

      el.innerHTML = `
        <div class="post-header">
          <div class="uicon">${escapeHtml((p.username||'U').slice(0,1).toUpperCase())}</div>
          <div class="meta">
            <div class="username">${escapeHtml(p.username || 'Unknown')}</div>
            <div class="time">${escapeHtml(timeAgo(p.timestamp))} ‚Ä¢ ${escapeHtml(new Date(p.timestamp?.toDate?.()||Date.now()).toLocaleString())}</div>
          </div>
        </div>
        <div class="caption">${escapeHtml(p.caption || '')}</div>
        ${p.imageURL ? `<img loading="lazy" class="post-image" src="${escapeHtml(p.imageURL)}" alt="post image">` : ''}
        <div class="prompt-block">
          <div class="prompt-text" title="Prompt">${escapeHtml(p.prompt || '')}</div>
          <button class="btn-copy" data-prompt="${escapeHtml(p.prompt || '')}">Copy</button>
        </div>
        <div class="actions">
          <button class="btn-like" data-liked="${userLiked ? '1' : '0'}" aria-pressed="${userLiked ? 'true' : 'false'}">
            <span class="heart">${userLiked ? '‚ù§Ô∏è' : 'ü§ç'}</span>
            <span class="count">${likeCount}</span>
          </button>
        </div>
      `;
      return el;
    }

    // Create Ad DOM element
    function createAdElement(a){
      const el = document.createElement('div');
      el.className = 'card ad-card';
      el.innerHTML = `<a href="${escapeHtml(a.link||'#')}" target="_blank" rel="noopener noreferrer"><img src="${escapeHtml(a.imageURL||'')}" alt="ad"></a>`;
      return el;
    }

    // Event delegation for actions: copy and like
    feedEl.addEventListener('click', async (ev) => {
      const copyBtn = ev.target.closest('.btn-copy');
      if(copyBtn){
        const prompt = copyBtn.dataset.prompt || '';
        try{
          await navigator.clipboard.writeText(prompt);
          const old = copyBtn.innerText;
          copyBtn.innerText = 'Copied!';
          setTimeout(()=> copyBtn.innerText = old, 1200);
        }catch(err){
          alert('Copy failed');
        }
        return;
      }

      const likeBtn = ev.target.closest('.btn-like');
      if(likeBtn){
        const postEl = likeBtn.closest('.post');
        const postId = postEl.dataset.id;
        if(!user || !user.uid){ alert('Please login to like'); return; }

        // optimistic UI update
        const countEl = likeBtn.querySelector('.count');
        let count = parseInt(countEl.innerText||'0',10);
        const liked = likeBtn.getAttribute('data-liked') === '1';

        // toggle
        if(liked){
          count = Math.max(0, count - 1);
          likeBtn.setAttribute('data-liked','0');
          likeBtn.setAttribute('aria-pressed','false');
          likeBtn.querySelector('.heart').textContent = 'ü§ç';
        } else {
          count = count + 1;
          likeBtn.setAttribute('data-liked','1');
          likeBtn.setAttribute('aria-pressed','true');
          likeBtn.querySelector('.heart').textContent = '‚ù§Ô∏è';
        }
        countEl.innerText = count;

        // write to Firestore
        try{
          const postRef = doc(db, 'posts', postId);
          if(liked){
            await updateDoc(postRef, { likes: arrayRemove(user.uid) });
          } else {
            await updateDoc(postRef, { likes: arrayUnion(user.uid) });
          }
        }catch(err){
          console.error('Like update failed', err);
          // revert UI
          if(liked){
            // we tried to remove but failed -> revert to liked
            count = count + 1;
            likeBtn.setAttribute('data-liked','1');
            likeBtn.querySelector('.heart').textContent = '‚ù§Ô∏è';
          } else {
            count = Math.max(0, count - 1);
            likeBtn.setAttribute('data-liked','0');
            likeBtn.querySelector('.heart').textContent = 'ü§ç';
          }
          countEl.innerText = count;
          alert('Could not update like. Try again.');
        }
      }
    });

    // Infinite scroll handler
    window.addEventListener('scroll', () => {
      if(isLoading) return;
      if((window.innerHeight + window.scrollY) >= (document.body.offsetHeight - 300)){
        // near bottom
        renderNextBatch();
      }
    });

    // Profile button
    profileBtn.addEventListener('click', () => {
      location.href = 'profile.html';
    });

    // On load: require auth or redirect, then load data
    (function init(){
      const ls = getLocalAuth();
      if(!ls || !ls.uid){
        // try Firebase auth state; if none, redirect to index
        onAuthStateChanged(auth, (u) => {
          if(u){
            // user logged in via firebase but maybe localStorage empty ‚Äî sync minimal
            user = { uid: u.uid, email: u.email };
            localStorage.setItem('ps_auth', JSON.stringify(user));
            loadData();
          } else {
            location.href = 'index.html';
          }
        });
      } else {
        user = ls;
        loadData();
      }
    })();

    // Utility to read local auth (again - accessible inside module)
    function getLocalAuth(){
      try{ return JSON.parse(localStorage.getItem('ps_auth')||'null'); }catch(e){ return null; }
    }

    // Optional: reload posts when user manually refreshes page ‚Äî handled by initial fetch (shuffle on load)
  </script>
</body>
</html>