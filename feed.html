<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prompt-Scientist ‚Äî Feed</title>
  <style>
    :root{
      --bg:#f8f9fb;
      --fg:#1a1a1a;
      --card:#fff;
      --border:#e5e7eb;
      --accent:#2563eb;
      --muted:#6b7280;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,system-ui,-apple-system,Roboto; background:var(--bg); color:var(--fg); overflow-x:hidden; scroll-behavior:smooth;}

    .topbar{position:fixed;top:0;left:0;right:0;height:60px;background:#fff;border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;padding:0 16px;z-index:1000;transition:transform .3s ease;}
    .brand{font-weight:700;font-size:26px;color:gray;}
    .actions{display:flex;align-items:center;gap:12px;}
    .search{padding:6px 8px;font-size:13px;border:1px solid var(--border);border-radius:6px;min-width:120px;}
    .profile{width:36px;height:36px;border-radius:50%;background:var(--muted);cursor:pointer;}

    .feed{margin-top:80px;max-width:650px;margin-left:auto;margin-right:auto;padding:12px;display:flex;flex-direction:column;gap:16px;}

    .post,.ad{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:14px;box-shadow:0 2px 6px rgba(0,0,0,.05);}
    .post-header{display:flex;align-items:center;gap:10px;margin-bottom:8px;}
    .avatar{width:40px;height:40px;border-radius:50%;background:var(--muted);}
    .name-time{display:flex;flex-direction:column;}
    .name{font-weight:600;font-size:15px;}
    .time{font-size:12px;color:var(--muted);}
    .caption{margin:8px 0;font-size:14px;}
    .post img{width:100%;border-radius:10px;margin-top:8px;}
    .prompt-box{background:#f3f4f6;padding:10px;border-radius:8px;margin-top:10px;font-size:13px;display:flex;justify-content:space-between;align-items:center;}
    .copy-btn{background:var(--accent);color:#fff;border:none;padding:5px 10px;font-size:12px;border-radius:6px;cursor:pointer;}

    .reactions{display:flex;gap:12px;margin-top:10px;font-size:14px;}
    .reaction-btn{cursor:pointer;display:flex;align-items:center;gap:4px;color:var(--muted);}
    .reaction-btn.active{color:var(--accent);font-weight:600;}

    .ad img{width:100%;border-radius:10px;cursor:pointer;}
    .ad span{font-size:12px;color:var(--muted);display:block;margin-top:4px;text-align:right;}

    @media(max-width:700px){
      .brand{font-size:22px;}
      .feed{padding:8px;}
      .search{min-width:100px;}
    }
  </style>
</head>
<body>
  <div class="topbar" id="topbar">
    <div class="brand">Prompt-Scientist</div>
    <div class="actions">
      <input id="searchBox" class="search" placeholder="Search..."/>
      <div class="profile" onclick="goProfile()"></div>
    </div>
  </div>

  <div id="feed" class="feed"></div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, collection, getDocs, doc, getDoc, query, orderBy, limit } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain: "prompt-scientist.firebaseapp.com",
      projectId: "prompt-scientist",
      storageBucket: "prompt-scientist.firebasestorage.app",
      messagingSenderId: "240705146800",
      appId: "1:240705146800:web:e7f05107761f4d3007d075"
    };
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);

    const feedEl = document.getElementById('feed');
    const searchBox = document.getElementById('searchBox');
    let posts = [];
    let ads = [];
    let userCache = {};

    // Load posts & ads
    async function loadData(){
      const snap = await getDocs(collection(db,"posts"));
      posts = snap.docs.map(d=>({id:d.id,...d.data()}));
      // Shuffle posts (random order)
      posts = posts.sort(()=>Math.random()-0.5);

      const adSnap = await getDocs(collection(db,"ads"));
      ads = adSnap.docs.map(d=>({id:d.id,...d.data()}));

      renderFeed(posts);
    }

    // Load user full name
    async function loadUserName(uid){
      if(userCache[uid]) return userCache[uid];
      try{
        const snap = await getDoc(doc(db,"users",uid));
        if(snap.exists()){
          const name = snap.data().name || "Unknown";
          userCache[uid]=name;
          return name;
        }
      }catch(e){console.error(e);}
      return "Unknown";
    }

    // Render feed with random ads
    async function renderFeed(items){
      feedEl.innerHTML="";
      for(let i=0;i<items.length;i++){
        const p = items[i];
        const userName = await loadUserName(p.uid);
        const div=document.createElement("div");
        div.className="post";
        div.innerHTML=`
          <div class="post-header">
            <div class="avatar"></div>
            <div class="name-time">
              <div class="name">${userName}</div>
              <div class="time">${new Date(p.createdAt?.seconds*1000||Date.now()).toLocaleString()}</div>
            </div>
          </div>
          <div class="caption">${p.caption||""}</div>
          ${p.image?`<img src="${p.image}"/>`:""}
          <div class="prompt-box"><span>${p.prompt}</span><button class="copy-btn" onclick="navigator.clipboard.writeText('${p.prompt}')">Copy</button></div>
          <div class="reactions">
            <div class="reaction-btn">üëç Like</div>
            <div class="reaction-btn">‚ù§Ô∏è Love</div>
            <div class="reaction-btn">üòÇ Haha</div>
            <div class="reaction-btn">üò° Angry</div>
            <div class="reaction-btn">üòÆ Wow</div>
          </div>
        `;
        feedEl.appendChild(div);

        // Random ad insert
        if(Math.random()<0.2 && ads.length>0){ 
          const ad = ads[Math.floor(Math.random()*ads.length)];
          const adDiv=document.createElement("div");
          adDiv.className="ad";
          adDiv.innerHTML=`<img src="${ad.image}" onclick="window.open('${ad.link}','_blank')"/><span>Sponsored</span>`;
          feedEl.appendChild(adDiv);
        }
      }
    }

    // Live search by caption
    searchBox.addEventListener("input", e=>{
      const val = e.target.value.toLowerCase();
      const filtered = posts.filter(p=> (p.caption||"").toLowerCase().includes(val));
      renderFeed(filtered);
    });

    // Profile page redirect
    window.goProfile=()=>location.href="profile.html";

    // Topbar hide/show on scroll
    let lastScroll=0;
    window.addEventListener("scroll",()=>{
      const tb=document.getElementById("topbar");
      if(window.scrollY>lastScroll){ tb.style.transform="translateY(-100%)"; }
      else{ tb.style.transform="translateY(0)"; }
      lastScroll=window.scrollY;
    });

    loadData();
  </script>
</body>
</html>
