<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prompt-Scientist ‚Äî Feed</title>
  <style>
    :root {
      --bg:#f3f4f6;
      --card:#fff;
      --muted:#6b7280;
      --accent:#2563eb;
      --brand:#374151;
      --radius:12px;
      --shadow:0 4px 12px rgba(16,24,40,0.08);
      --maxw:860px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    body{font-family:Inter,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;background:var(--bg);color:#111827;line-height:1.5}

    /* ==== Topbar ==== */
    .topbar{
      position:sticky;top:0;z-index:100;
      background:#fff;
      max-width:var(--maxw);
      margin:0 auto;
      padding:12px 18px;
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      border-bottom:1px solid #e5e7eb;
      transition:transform .35s ease,opacity .35s ease;
    }
    .topbar.hide{transform:translateY(-100%);opacity:0}
    .brand h1{font-size:22px;font-weight:800;color:var(--accent);white-space:nowrap}
    .search-box{flex:1;max-width:240px}
    .search-box input{width:100%;padding:7px 10px;border:1px solid #d1d5db;border-radius:8px;font-size:14px;}
    .profile-btn{width:40px;height:40px;border-radius:50%;border:1px solid #d1d5db;background:#fff;
      display:grid;place-items:center;cursor:pointer;box-shadow:0 2px 6px rgba(0,0,0,0.05);font-size:18px}

    /* ==== Feed ==== */
    .container{max-width:var(--maxw);margin:0 auto;padding:0 18px 80px}
    .feed{margin-top:14px;display:flex;flex-direction:column;gap:16px}
    .card{background:var(--card);border-radius:var(--radius);padding:14px;border:1px solid #e5e7eb;box-shadow:var(--shadow)}

    .post-header{display:flex;gap:12px;align-items:center}
    .uicon{width:44px;height:44px;border-radius:50%;display:grid;place-items:center;font-weight:700;color:#fff;font-size:18px}
    .meta{display:flex;flex-direction:column}
    .username{font-weight:700}
    .time{font-size:12px;color:var(--muted)}

    .caption{margin-top:10px;white-space:pre-wrap;line-height:1.45}
    .post-image{width:100%;max-height:480px;object-fit:cover;margin-top:12px;border-radius:10px}

    .prompt-block{margin-top:12px;padding:10px;border-radius:10px;background:#f9fafb;border:1px solid #e5e7eb;
      display:flex;justify-content:space-between;gap:12px;align-items:center}
    .prompt-text{font-family:ui-monospace,monospace;font-size:13px;color:#111827;flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
    .btn-copy{padding:6px 12px;border-radius:8px;border:none;background:var(--accent);color:#fff;cursor:pointer;font-size:13px}
    .btn-copy:hover{background:#1e4fc6}

    .actions{display:flex;gap:8px;align-items:center;margin-top:12px;flex-wrap:wrap}
    .btn-react{display:inline-flex;align-items:center;gap:6px;padding:5px 10px;
      border-radius:20px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-size:14px;transition:all .2s}
    .btn-react.active{background:#e0ecff;border-color:#c7dfff}
    .btn-react .count{font-weight:600;font-size:13px;color:#374151}

    /* ==== Ads ==== */
    .ad-card{padding:0;border:1px solid #e5e7eb;overflow:hidden;position:relative;border-radius:var(--radius);box-shadow:var(--shadow)}
    .ad-card img{width:100%;height:auto;display:block}
    .ad-card .sponsored{position:absolute;top:6px;left:8px;background:#00000099;color:#fff;font-size:12px;padding:2px 6px;border-radius:6px}

    /* ==== States ==== */
    .loading,.empty{padding:18px;text-align:center;color:var(--muted)}

    @media(max-width:600px){
      .brand h1{font-size:18px}
      .search-box{max-width:150px}
    }
  </style>
</head>
<body>
  <header id="topbar" class="topbar">
    <div class="brand"><h1>Prompt-Scientist</h1></div>
    <div class="search-box"><input id="searchInput" type="text" placeholder="Search..."></div>
    <button id="profileBtn" class="profile-btn" title="Profile">üë§</button>
  </header>

  <main class="container">
    <section id="feed" class="feed" aria-live="polite"></section>
    <div id="loading" class="loading">Loading posts‚Ä¶</div>
    <div id="endMsg" class="empty" style="display:none">No more posts</div>
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain:"prompt-scientist.firebaseapp.com",
      projectId:"prompt-scientist",
      storageBucket:"prompt-scientist.firebasestorage.app",
      messagingSenderId:"240705146800",
      appId:"1:240705146800:web:e7f05107761f4d3007d075"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);

    const feedEl=document.getElementById("feed");
    const loadingEl=document.getElementById("loading");
    const endMsgEl=document.getElementById("endMsg");
    const profileBtn=document.getElementById("profileBtn");
    const topbar=document.getElementById("topbar");
    const searchInput=document.getElementById("searchInput");

    let posts=[];let ads=[];let user=null;let currentIndex=0;
    const PAGE_SIZE=6;
    const userCache={};

    // === Utilities ===
    const randomColor=()=>["#2563eb","#dc2626","#16a34a","#9333ea","#ea580c","#0d9488"][Math.floor(Math.random()*6)];
    const escapeHtml=(s="")=>s.replace(/[&<>]/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]));
    const timeAgo=ts=>{try{const d=ts?.toDate?ts.toDate():new Date(ts);const sec=(Date.now()-d)/1000;
      if(sec<60)return`${Math.floor(sec)}s`;if(sec<3600)return`${Math.floor(sec/60)}m`;
      if(sec<86400)return`${Math.floor(sec/3600)}h`;return`${Math.floor(sec/86400)}d`;}catch{return"";}};
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a};

    async function loadUserName(uid){
      if(userCache[uid]) return userCache[uid];
      try{const snap=await getDoc(doc(db,"users",uid));
        if(snap.exists()){return userCache[uid]=snap.data().name||"Unknown";}
      }catch{}return "Unknown";
    }

    // === Load posts & ads ===
    async function loadData(){
      loadingEl.style.display="block";feedEl.innerHTML="";endMsgEl.style.display="none";currentIndex=0;
      try{
        const snap=await getDocs(query(collection(db,"posts"),where("approved","==",true)));
        posts=shuffle(await Promise.all(snap.docs.map(async d=>{
          const data=d.data();return{id:d.id,...data,name:await loadUserName(data.uid),color:randomColor()};
        })));
        const snapAds=await getDocs(collection(db,"ads"));
        ads=snapAds.docs.map(d=>({id:d.id,...d.data()}));
        renderNext();
      }finally{loadingEl.style.display="none";}
    }

    // === Render next page ===
    function renderNext(){
      if(currentIndex>=posts.length){endMsgEl.style.display="block";return;}
      const frag=document.createDocumentFragment();
      const end=Math.min(currentIndex+PAGE_SIZE,posts.length);
      for(let i=currentIndex;i<end;i++) frag.appendChild(renderPost(posts[i]));
      if(ads.length && Math.random()<0.35) frag.appendChild(renderAd(ads[Math.floor(Math.random()*ads.length)]));
      feedEl.appendChild(frag);
      currentIndex=end;
    }

    // === Render helpers ===
    function renderPost(p){
      const reactions=p.reactions||{};
      const myReact=user?reactions[user.uid]:null;
      const counts={like:0,love:0,haha:0,angry:0,wow:0};
      Object.values(reactions).forEach(r=>counts[r]!==undefined&&counts[r]++);
      const el=document.createElement("article");
      el.className="card post";el.dataset.id=p.id;
      el.innerHTML=`
        <div class="post-header">
          <div class="uicon" style="background:${p.color}">${escapeHtml((p.name||"U")[0])}</div>
          <div class="meta"><div class="username">${escapeHtml(p.name||"Unknown")}</div>
          <div class="time">${timeAgo(p.timestamp)}</div></div>
        </div>
        <div class="caption">${escapeHtml(p.caption||"")}</div>
        ${p.imageURL?`<img class="post-image" src="${escapeHtml(p.imageURL)}" alt="post">`:""}
        <div class="prompt-block"><div class="prompt-text">${escapeHtml(p.prompt||"")}</div>
          <button class="btn-copy" data-prompt="${escapeHtml(p.prompt||"")}">Copy</button></div>
        <div class="actions">
          ${reactionBtn("like","üëç",counts.like,myReact)}
          ${reactionBtn("love","‚ù§Ô∏è",counts.love,myReact)}
          ${reactionBtn("haha","üòÇ",counts.haha,myReact)}
          ${reactionBtn("angry","üò°",counts.angry,myReact)}
          ${reactionBtn("wow","üòÆ",counts.wow,myReact)}
        </div>`;
      return el;
    }

    const reactionBtn=(t,e,c,my)=>`<button class="btn-react ${my===t?"active":""}" data-type="${t}">
      <span>${e}</span> <span class="count">${c}</span></button>`;

    function renderAd(a){
      const el=document.createElement("div");
      el.className="card ad-card";
      el.innerHTML=`<span class="sponsored">Sponsored</span>
        <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noopener">
          <img src="${escapeHtml(a.imageURL||"")}" alt="ad">
        </a>`;
      return el;
    }

    // === Events ===
    feedEl.addEventListener("click",async e=>{
      const copy=e.target.closest(".btn-copy");
      if(copy){
        try{await navigator.clipboard.writeText(copy.dataset.prompt);
          copy.textContent="Copied!";setTimeout(()=>copy.textContent="Copy",1200);}catch{alert("Copy failed");}
      }
      const react=e.target.closest(".btn-react");
      if(react){
        if(!user) return alert("Login required");
        const postEl=react.closest(".post");const id=postEl.dataset.id;const type=react.dataset.type;
        try{
          await updateDoc(doc(db,"posts",id),{[`reactions.${user.uid}`]:type});
          updateReactionUI(postEl,type);
        }catch(err){console.error(err);}
      }
    });

    function updateReactionUI(postEl,myType){
      postEl.querySelectorAll(".btn-react").forEach(btn=>{
        const isActive=btn.dataset.type===myType;
        btn.classList.toggle("active",isActive);
        const countEl=btn.querySelector(".count");
        let count=parseInt(countEl.textContent)||0;
        if(isActive) count++;else if(btn.classList.contains("active")) count--;
        countEl.textContent=Math.max(0,count);
      });
    }

    searchInput.addEventListener("input",()=>{
      const term=searchInput.value.toLowerCase();
      feedEl.querySelectorAll(".post").forEach(p=>{
        const caption=p.querySelector(".caption").textContent.toLowerCase();
        const username=p.querySelector(".username").textContent.toLowerCase();
        p.style.display=(caption.includes(term)||username.includes(term))?"block":"none";
      });
    });

    window.addEventListener("scroll",()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-300) renderNext();});
    profileBtn.addEventListener("click",()=>location.href="profile.html");

    let lastY=0;
    window.addEventListener("scroll",()=>{const y=window.scrollY;
      if(y>lastY&&y>60) topbar.classList.add("hide"); else topbar.classList.remove("hide");
      lastY=y;
    });

    // === Auth ===
    onAuthStateChanged(auth,u=>{
      if(u){user={uid:u.uid,email:u.email};loadData();}else{location.href="index.html";}
    });
  </script>
</body>
</html>
