<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>Prompt-Scientist ‚Äî Feed</title>
  <style>
    :root {
      --bg: #0d1117;
      --card: rgba(20, 25, 35, 0.85);
      --muted: #8b9cb5;
      --accent: #3b82f6;
      --accent-glow: 0 0 15px rgba(59,130,246,0.7);
      --radius: 14px;
      --shadow: 0 6px 16px rgba(0,0,0,0.6);
      --maxw: 900px;
    }

    *{box-sizing:border-box;margin:0;padding:0}
    body{
      font-family:"Orbitron","Segoe UI",Roboto,Arial,sans-serif;
      background: radial-gradient(circle at top, #0f172a, #0d1117 70%);
      color:#e2e8f0;line-height:1.6;
      min-height:100vh;
    }

    /* ==== Topbar ==== */
    .topbar{
      position:sticky;top:0;z-index:100;
      background:rgba(18,24,38,0.9);
      border-bottom:1px solid rgba(59,130,246,0.5);
      backdrop-filter:blur(12px);
      box-shadow:0 4px 16px rgba(0,0,0,0.6);
      display:flex;align-items:center;justify-content:space-between;gap:10px;
      max-width:var(--maxw);margin:0 auto;padding:14px 20px;
      transition:transform .35s ease,opacity .35s ease;
    }
    .topbar.hide{transform:translateY(-100%);opacity:0}
    .brand h1{
      font-size:22px;font-weight:800;
      background:linear-gradient(90deg,#3b82f6,#8b5cf6);
      -webkit-background-clip:text;
      -webkit-text-fill-color:transparent;
      letter-spacing:1px;
    }
    .search-box{flex:1;max-width:260px}
    .search-box input{
      width:100%;padding:8px 12px;border:1px solid rgba(59,130,246,0.4);
      border-radius:8px;font-size:14px;background:#111827;color:#e2e8f0;
      transition:all .25s;
    }
    .search-box input:focus{border-color:#60a5fa;box-shadow:0 0 12px rgba(59,130,246,0.6);outline:none}
    .profile-btn{
      width:42px;height:42px;border-radius:50%;
      border:1px solid rgba(148,163,184,0.4);
      background:linear-gradient(145deg,#1e293b,#0f172a);
      display:grid;place-items:center;cursor:pointer;
      font-size:18px;color:#60a5fa;
      box-shadow:inset 0 0 10px rgba(59,130,246,0.5);
      transition:all .3s;
    }
    .profile-btn:hover{transform:scale(1.1);box-shadow:0 0 20px rgba(59,130,246,0.7)}

    /* ==== Feed ==== */
    .container{max-width:var(--maxw);margin:0 auto;padding:0 20px 80px}
    .feed{margin-top:20px;display:flex;flex-direction:column;gap:20px}
    .card{
      background:var(--card);
      border-radius:var(--radius);
      padding:18px;
      border:1px solid rgba(59,130,246,0.3);
      box-shadow:var(--shadow);
      transition:transform .3s,box-shadow .3s,border .3s;
    }
    .card:hover{
      transform:translateY(-4px);
      border-color:#3b82f6;
      box-shadow:0 0 20px rgba(59,130,246,0.6);
    }

    .post-header{display:flex;gap:12px;align-items:center}
    .uicon{
      width:48px;height:48px;border-radius:50%;
      display:grid;place-items:center;
      font-weight:700;color:#fff;font-size:18px;
      background:linear-gradient(135deg,#3b82f6,#8b5cf6);
      box-shadow:0 0 12px rgba(59,130,246,0.7);
    }
    .meta{display:flex;flex-direction:column}
    .username{font-weight:700;font-size:15px;color:#fff}
    .time{font-size:12px;color:var(--muted)}

    .caption{margin-top:12px;white-space:pre-wrap;line-height:1.5;font-size:15px;color:#e2e8f0}
    .post-image{
      width:100%;max-height:480px;object-fit:cover;
      margin-top:14px;border-radius:12px;
      border:1px solid rgba(59,130,246,0.3);
      transition:all .3s;
    }
    .post-image:hover{transform:scale(1.02);box-shadow:0 0 20px rgba(139,92,246,0.6)}

    .prompt-block{
      margin-top:14px;padding:12px;
      border-radius:12px;
      background:rgba(15,23,42,0.8);
      border:1px solid rgba(139,92,246,0.4);
      display:flex;justify-content:space-between;gap:12px;align-items:center;
      box-shadow:inset 0 0 12px rgba(139,92,246,0.3);
    }
    .prompt-text{
      font-family:"Share Tech Mono",monospace;
      font-size:13px;color:#93c5fd;
      flex:1;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;
    }
    .btn-copy{
      padding:7px 14px;border-radius:6px;border:none;
      background:linear-gradient(90deg,#3b82f6,#8b5cf6);
      color:#fff;cursor:pointer;font-size:13px;font-weight:600;
      transition:all .25s;
      box-shadow:0 0 12px rgba(59,130,246,0.6);
    }
    .btn-copy:hover{transform:scale(1.08);box-shadow:0 0 20px rgba(139,92,246,0.8)}

    .actions{display:flex;gap:10px;align-items:center;margin-top:14px;flex-wrap:wrap}
    .btn-react{
      display:inline-flex;align-items:center;gap:6px;
      padding:6px 12px;border-radius:20px;
      border:1px solid rgba(59,130,246,0.3);
      background:rgba(17,24,39,0.7);cursor:pointer;font-size:14px;
      transition:all .25s;
      color:#e2e8f0;
    }
    .btn-react:hover{background:#1e293b;box-shadow:0 0 12px rgba(59,130,246,0.5)}
    .btn-react.active{background:#3b82f6;color:#fff;box-shadow:0 0 15px rgba(59,130,246,0.7)}
    .btn-react .count{font-weight:600;font-size:13px;color:#93c5fd}

    /* ==== Ads ==== */
    .ad-card{padding:0;border:1px solid rgba(139,92,246,0.5);overflow:hidden;position:relative;border-radius:var(--radius);box-shadow:0 0 20px rgba(139,92,246,0.4)}
    .ad-card img{width:100%;height:auto;display:block;transition:transform .4s}
    .ad-card img:hover{transform:scale(1.08)}
    .ad-card .sponsored{position:absolute;top:8px;left:10px;background:rgba(0,0,0,0.7);color:#fff;font-size:12px;padding:3px 8px;border-radius:8px}

    /* ==== States ==== */
    .loading,.empty{padding:20px;text-align:center;color:var(--muted);font-size:14px}

    @media(max-width:600px){
      .brand h1{font-size:18px}
      .search-box{max-width:150px}
      .caption{font-size:14px}
    }
  </style>
</head>
<body>
  <header id="topbar" class="topbar">
    <div class="brand"><h1>Prompt-Scientist</h1></div>
    <div class="search-box"><input id="searchInput" type="text" placeholder="Search..."></div>
    <button id="profileBtn" class="profile-btn" title="Profile">ü§ñ</button>
  </header>

  <main class="container">
    <section id="feed" class="feed" aria-live="polite"></section>
    <div id="loading" class="loading">Loading posts‚Ä¶</div>
    <div id="endMsg" class="empty" style="display:none">No more posts</div>
  </main>

  <!-- JavaScript ‡¶Ö‡¶Ç‡¶∂ ‡¶Ö‡¶™‡¶∞‡¶ø‡¶¨‡¶∞‡ßç‡¶§‡¶ø‡¶§ -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, getDocs, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig = {
      apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain:"prompt-scientist.firebaseapp.com",
      projectId:"prompt-scientist",
      storageBucket:"prompt-scientist.firebasestorage.app",
      messagingSenderId:"240705146800",
      appId:"1:240705146800:web:e7f05107761f4d3007d075"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);

    const feedEl=document.getElementById("feed");
    const loadingEl=document.getElementById("loading");
    const endMsgEl=document.getElementById("endMsg");
    const profileBtn=document.getElementById("profileBtn");
    const topbar=document.getElementById("topbar");
    const searchInput=document.getElementById("searchInput");

    let posts=[];let ads=[];let user=null;let currentIndex=0;
    const PAGE_SIZE=6;
    const userCache={};

    const randomColor=()=>["#3b82f6","#8b5cf6","#06b6d4","#f43f5e","#22c55e","#eab308"][Math.floor(Math.random()*6)];
    const escapeHtml=(s="")=>s.replace(/[&<>]/g,ch=>({"&":"&amp;","<":"&lt;",">":"&gt;"}[ch]));
    const timeAgo=ts=>{try{const d=ts?.toDate?ts.toDate():new Date(ts);const sec=(Date.now()-d)/1000;
      if(sec<60)return`${Math.floor(sec)}s`;if(sec<3600)return`${Math.floor(sec/60)}m`;
      if(sec<86400)return`${Math.floor(sec/3600)}h`;return`${Math.floor(sec/86400)}d`;}catch{return"";}};
    const shuffle=a=>{for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a};

    async function loadUserName(uid){
      if(userCache[uid]) return userCache[uid];
      try{const snap=await getDoc(doc(db,"users",uid));
        if(snap.exists()){return userCache[uid]=snap.data().name||"Unknown";}
      }catch{}return "Unknown";
    }

    async function loadData(){
      loadingEl.style.display="block";feedEl.innerHTML="";endMsgEl.style.display="none";currentIndex=0;
      try{
        const snap=await getDocs(query(collection(db,"posts"),where("approved","==",true)));
        posts=shuffle(await Promise.all(snap.docs.map(async d=>{
          const data=d.data();return{id:d.id,...data,name:await loadUserName(data.uid),color:randomColor()};
        })));
        const snapAds=await getDocs(collection(db,"ads"));
        ads=snapAds.docs.map(d=>({id:d.id,...d.data()}));
        renderNext();
      }finally{loadingEl.style.display="none";}
    }

    function renderNext(){
      if(currentIndex>=posts.length){endMsgEl.style.display="block";return;}
      const frag=document.createDocumentFragment();
      const end=Math.min(currentIndex+PAGE_SIZE,posts.length);
      for(let i=currentIndex;i<end;i++) frag.appendChild(renderPost(posts[i]));
      if(ads.length && Math.random()<0.35) frag.appendChild(renderAd(ads[Math.floor(Math.random()*ads.length)]));
      feedEl.appendChild(frag);
      currentIndex=end;
    }

    function renderPost(p){
      const reactions=p.reactions||{};
      const myReact=user?reactions[user.uid]:null;
      const counts={like:0,love:0,haha:0,angry:0,wow:0};
      Object.values(reactions).forEach(r=>counts[r]!==undefined&&counts[r]++);
      const el=document.createElement("article");
      el.className="card post";el.dataset.id=p.id;
      el.innerHTML=`
        <div class="post-header">
          <div class="uicon" style="background:${p.color}">${escapeHtml((p.name||"U")[0])}</div>
          <div class="meta"><div class="username">${escapeHtml(p.name||"Unknown")}</div>
          <div class="time">${timeAgo(p.timestamp)}</div></div>
        </div>
        <div class="caption">${escapeHtml(p.caption||"")}</div>
        ${p.imageURL?`<img class="post-image" src="${escapeHtml(p.imageURL)}" alt="post">`:""}
        <div class="prompt-block"><div class="prompt-text">${escapeHtml(p.prompt||"")}</div>
          <button class="btn-copy" data-prompt="${escapeHtml(p.prompt||"")}">Copy</button></div>
        <div class="actions">
          ${reactionBtn("like","üëç",counts.like,myReact)}
          ${reactionBtn("love","‚ù§Ô∏è",counts.love,myReact)}
          ${reactionBtn("haha","üòÇ",counts.haha,myReact)}
          ${reactionBtn("angry","üò°",counts.angry,myReact)}
          ${reactionBtn("wow","üòÆ",counts.wow,myReact)}
        </div>`;
      return el;
    }

    const reactionBtn=(t,e,c,my)=>`<button class="btn-react ${my===t?"active":""}" data-type="${t}">
      <span>${e}</span> <span class="count">${c}</span></button>`;

    function renderAd(a){
      const el=document.createElement("div");
      el.className="card ad-card";
      el.innerHTML=`<span class="sponsored">Sponsored</span>
        <a href="${escapeHtml(a.link||"#")}" target="_blank" rel="noopener">
          <img src="${escapeHtml(a.imageURL||"")}" alt="ad">
        </a>`;
      return el;
    }

    feedEl.addEventListener("click",async e=>{
      const copy=e.target.closest(".btn-copy");
      if(copy){
        try{await navigator.clipboard.writeText(copy.dataset.prompt);
          copy.textContent="Copied!";setTimeout(()=>copy.textContent="Copy",1200);}catch{alert("Copy failed");}
      }
      const react=e.target.closest(".btn-react");
      if(react){
        if(!user) return alert("Login required");
        const postEl=react.closest(".post");const id=postEl.dataset.id;const type=react.dataset.type;
        try{
          await updateDoc(doc(db,"posts",id),{[`reactions.${user.uid}`]:type});
          updateReactionUI(postEl,type);
        }catch(err){console.error(err);}
      }
    });

    function updateReactionUI(postEl,myType){
      postEl.querySelectorAll(".btn-react").forEach(btn=>{
        const isActive=btn.dataset.type===myType;
        btn.classList.toggle("active",isActive);
        const countEl=btn.querySelector(".count");
        let count=parseInt(countEl.textContent)||0;
        if(isActive) count++;else if(btn.classList.contains("active")) count--;
        countEl.textContent=Math.max(0,count);
      });
    }

    searchInput.addEventListener("input",()=>{
      const term=searchInput.value.toLowerCase();
      feedEl.querySelectorAll(".post").forEach(p=>{
        const caption=p.querySelector(".caption").textContent.toLowerCase();
        const username=p.querySelector(".username").textContent.toLowerCase();
        p.style.display=(caption.includes(term)||username.includes(term))?"block":"none";
      });
    });

    window.addEventListener("scroll",()=>{if(window.innerHeight+window.scrollY>=document.body.offsetHeight-300) renderNext();});
    profileBtn.addEventListener("click",()=>location.href="profile.html");

    let lastY=0;
    window.addEventListener("scroll",()=>{const y=window.scrollY;
      if(y>lastY&&y>60) topbar.classList.add("hide"); else topbar.classList.remove("hide");
      lastY=y;
    });

    // === Auth ===
    onAuthStateChanged(auth,u=>{
      if(u){user={uid:u.uid,email:u.email};loadData();}else{location.href="index.html";}
    });
  </script>
</body>
</html>
