<!doctype html>
<html lang="bn">
<head>
  <meta charset="utf-8"/>  
  <meta name="viewport" content="width=device-width,initial-scale=1"/>  
  <title>Prompt-Scientist ‚Äî Feed</title>  
  <style>
    :root {
      --bg:#f0f2f5;
      --card:#fff;
      --muted:#65676b;
      --accent:#1877f2;
      --brand:#050505;
      --radius:10px;
      --shadow:0 2px 8px rgba(0,0,0,0.08);
      --maxw:680px;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html{scroll-behavior:smooth;}
    body{
      font-family:Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background:var(--bg);color:#050505;line-height:1.5;
    }
    .topbar{
      position:sticky;top:0;z-index:100;background:#fff;
      max-width:100%;
      padding:10px 16px;
      display:flex;align-items:center;justify-content:space-between;
      border-bottom:1px solid #ddd;
      box-shadow:0 1px 4px rgba(0,0,0,0.05);
    }
    .brand h1{font-size:22px;font-weight:700;color:var(--accent);}
    .search-box{flex:1;max-width:220px;margin:0 10px;}
    .search-box input{
      width:100%;padding:6px 12px;border:1px solid #ddd;border-radius:20px;
      font-size:14px;background:#f0f2f5;
    }
    .profile-btn{
      width:36px;height:36px;border-radius:50%;border:1px solid #ddd;
      background:#fff;display:grid;place-items:center;cursor:pointer;font-size:18px;
    }
    .container{max-width:var(--maxw);margin:0 auto;padding:16px;}
    .feed{display:flex;flex-direction:column;gap:16px}
    .card{
      background:var(--card);border-radius:var(--radius);
      padding:12px 14px;border:1px solid #ddd;box-shadow:var(--shadow);
    }
    .post-header{display:flex;gap:10px;align-items:center;margin-bottom:8px;}
    .uicon{width:40px;height:40px;border-radius:50%;
      display:grid;place-items:center;font-weight:700;color:#fff;font-size:16px;}
    .meta{display:flex;flex-direction:column}
    .username{font-weight:600;font-size:15px;}
    .time{font-size:12px;color:var(--muted);}
    .caption{margin:6px 0;font-size:15px;}
    .post-image{width:100%;max-height:520px;object-fit:cover;margin-top:8px;border-radius:6px}
    .prompt-block{
      margin-top:8px;padding:8px;border-radius:6px;background:#f7f7f7;border:1px solid #ddd;
      display:flex;justify-content:space-between;gap:8px;align-items:center;font-size:13px;
    }
    .btn-copy{
      padding:6px 10px;border-radius:20px;border:none;
      background:var(--accent);color:#fff;cursor:pointer;font-size:13px;
    }
    .btn-copy:hover{background:#1459c5}
    .actions{
      display:flex;align-items:center;margin-top:10px;flex-wrap:wrap;
      border-top:1px solid #eee;padding-top:8px;gap:8px;
      position:relative;
    }
    .btn-react{
      display:inline-flex;align-items:center;gap:4px;padding:6px 10px;
      border-radius:20px;border:1px solid #ddd;background:#f0f2f5;cursor:pointer;
      font-size:13px;color:#050505;transition:all .2s;
      position:relative;
    }
    .btn-react.active{background:#e7f3ff;border-color:#cce0ff;color:#1877f2;}
    .btn-react .count{font-weight:500}
    /* Reaction popup */
    .reaction-popup{
      display:none;position:absolute;bottom:120%;left:0;z-index:50;
      background:#fff;border:1px solid #ddd;border-radius:30px;
      box-shadow:0 2px 8px rgba(0,0,0,0.15);
      padding:6px 8px;gap:8px;display:flex;
    }
    .reaction-popup button{
      background:none;border:none;font-size:20px;cursor:pointer;transition:transform .2s;
    }
    .reaction-popup button:hover{transform:scale(1.3);}
    .btn-react:hover .reaction-popup{display:flex;}
    /* Ads */
    .ad-card{border:1px solid #ddd;border-radius:var(--radius);overflow:hidden;
      background:#fff;box-shadow:var(--shadow);position:relative;}
    .ad-card img{width:100%;height:auto;display:block}
    .ad-card .sponsored{
      position:absolute;top:6px;left:8px;background:#00000099;color:#fff;
      font-size:12px;padding:2px 6px;border-radius:6px;
    }
    .loading{padding:18px;text-align:center;color:var(--muted)}
    .empty{padding:28px;text-align:center;color:var(--muted)}
  </style>
</head>
<body>
  <header class="topbar">  
    <div class="brand"><h1>Prompt-Scientist</h1></div>  
    <div class="search-box"><input id="searchInput" type="text" placeholder="Search..."></div>  
    <button id="profileBtn" class="profile-btn">üë§</button>  
  </header>
  <main class="container">  
    <section id="feed" class="feed"></section>  
    <div id="loading" class="loading">Loading posts‚Ä¶</div>  
    <div id="endMsg" class="empty" style="display:none">No more posts</div>  
  </main>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
    import { getFirestore, collection, query, where, onSnapshot, doc, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

    const firebaseConfig={
      apiKey:"AIzaSyDDgwI90DMBa25JOkNR2Oec32kfgIt5TNg",
      authDomain:"prompt-scientist.firebaseapp.com",
      projectId:"prompt-scientist",
      storageBucket:"prompt-scientist.firebasestorage.app",
      messagingSenderId:"240705146800",
      appId:"1:240705146800:web:e7f05107761f4d3007d075"
    };
    const app=initializeApp(firebaseConfig);
    const auth=getAuth(app);
    const db=getFirestore(app);

    const feedEl=document.getElementById('feed');
    const loadingEl=document.getElementById('loading');
    const profileBtn=document.getElementById('profileBtn');
    const searchInput=document.getElementById('searchInput');

    let posts=[];let user=null;const userCache={};

    async function loadUserName(uid){
      if(userCache[uid])return userCache[uid];
      try{const snap=await getDoc(doc(db,"users",uid));
        if(snap.exists()){userCache[uid]=snap.data().name||"Unknown";return userCache[uid];}
      }catch{}return"Unknown";
    }
    const randomColor=()=>["#1877f2","#e41e3f","#22c55e","#9333ea","#ea580c","#0d9488"][Math.floor(Math.random()*6)];
    const escapeHtml=s=>String(s||'').replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;');
    const timeAgo=ts=>{try{const d=ts?.toDate?ts.toDate():new Date(ts);const sec=Math.floor((Date.now()-d.getTime())/1000);
      if(sec<60)return sec+"s";if(sec<3600)return Math.floor(sec/60)+"m";
      if(sec<86400)return Math.floor(sec/3600)+"h";return Math.floor(sec/86400)+"d";}catch{return"";}};

    function renderPost(p){
      const reactions=p.reactions||{};const myReact=user?reactions[user.uid]||null:null;
      const counts={like:0,love:0,haha:0,angry:0,wow:0};
      Object.values(reactions).forEach(r=>{if(counts[r]!==undefined)counts[r]++;});
      const el=document.createElement('article');el.className='card post';el.dataset.id=p.id;
      el.innerHTML=`
        <div class="post-header">
          <div class="uicon" style="background:${p.color}">${escapeHtml((p.name||'U')[0])}</div>
          <div class="meta"><div class="username">${escapeHtml(p.name||'Unknown')}</div>
          <div class="time">${timeAgo(p.timestamp)}</div></div>
        </div>
        <div class="caption">${escapeHtml(p.caption||'')}</div>
        ${p.imageURL?`<img class="post-image" src="${escapeHtml(p.imageURL)}" alt="post">`:''}
        <div class="prompt-block"><div class="prompt-text">${escapeHtml(p.prompt||'')}</div>
          <button class="btn-copy" data-prompt="${escapeHtml(p.prompt||'')}">Copy</button></div>
        <div class="actions">
          <button class="btn-react ${myReact?'active':''}" data-type="${myReact||'like'}">
            üëç <span class="count">${Object.values(counts).reduce((a,b)=>a+b,0)}</span>
            <div class="reaction-popup">
              <button data-react="like">üëç</button>
              <button data-react="love">‚ù§Ô∏è</button>
              <button data-react="haha">üòÇ</button>
              <button data-react="wow">üòÆ</button>
              <button data-react="angry">üò°</button>
            </div>
          </button>
        </div>`;
      return el;
    }

    function renderAd(){
      const ad=document.createElement('div');ad.className='ad-card';
      ad.innerHTML=`<div class="sponsored">Sponsored</div>
        <img src="https://picsum.photos/600/300?random=${Math.floor(Math.random()*1000)}" alt="ad">`;
      return ad;
    }

    function shuffle(arr){
      for(let i=arr.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[arr[i],arr[j]]=[arr[j],arr[i]];}
      return arr;
    }

    function subscribePosts(){
      const q=query(collection(db,'posts'),where('approved','==',true));
      onSnapshot(q, async snap=>{
        let list=await Promise.all(snap.docs.map(async d=>{
          const data=d.data();const name=await loadUserName(data.uid);
          return{id:d.id,...data,name,color:randomColor()};
        }));
        list=shuffle(list);
        // random ad inject
        const final=[];list.forEach((p,i)=>{final.push(p);if(Math.random()<0.25)final.push({ad:true});});
        posts=final;
        feedEl.innerHTML='';
        posts.forEach(p=>{feedEl.appendChild(p.ad?renderAd():renderPost(p));});
        loadingEl.style.display='none';
      });
    }

    feedEl.addEventListener('click',async e=>{
      const c=e.target.closest('.btn-copy');if(c){try{await navigator.clipboard.writeText(c.dataset.prompt);
        c.innerText="Copied!";setTimeout(()=>c.innerText="Copy",1200);}catch{alert("Copy failed");}}
      const r=e.target.closest('[data-react]');if(r){
        const postEl=r.closest('.post');if(!postEl)return;const id=postEl.dataset.id;const type=r.dataset.react;
        if(!user){alert("Login required");return;}
        try{await updateDoc(doc(db,'posts',id),{[`reactions.${user.uid}`]:type});}
        catch(err){console.error(err);}
      }
    });

    searchInput.addEventListener('input',()=>{
      const term=searchInput.value.toLowerCase();
      feedEl.querySelectorAll('.post').forEach(p=>{
        const caption=p.querySelector('.caption').innerText.toLowerCase();
        const username=p.querySelector('.username').innerText.toLowerCase();
        p.style.display=(caption.includes(term)||username.includes(term))?'block':'none';
      });
    });

    profileBtn.addEventListener('click',()=>location.href='profile.html');
    onAuthStateChanged(auth,u=>{if(u){user={uid:u.uid,email:u.email};subscribePosts();}else{location.href='index.html';}});
  </script>
</body>
</html>
